<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    
    <meta name="description" content="Finding bugs is hard, reverse engineering is hard. Constraint solvers are the heart of many program analysis techniques, and can aid Fuzzing, and software verification.
This post contains a few hands-on experiments with Z3, a high performance theorem prover developed at Microsoft Research by Leonardo de Moura and Nikolaj Bjorner. With KLEE, a Symbolic Execution Engine built on top of the LLVM compiler infrastructure developed by Cristian Cadar, Daniel Dunbar, and Dawson Engler.">
    <meta name="keywords" content="homepage, blog, reversing, binary exploitation, kernel, hypervisor, containers">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Practical Symbolic Execution and SATisfiability Module Theories (SMT) 101"/>
<meta name="twitter:description" content="Finding bugs is hard, reverse engineering is hard. Constraint solvers are the heart of many program analysis techniques, and can aid Fuzzing, and software verification.
This post contains a few hands-on experiments with Z3, a high performance theorem prover developed at Microsoft Research by Leonardo de Moura and Nikolaj Bjorner. With KLEE, a Symbolic Execution Engine built on top of the LLVM compiler infrastructure developed by Cristian Cadar, Daniel Dunbar, and Dawson Engler."/>

    <meta property="og:title" content="Practical Symbolic Execution and SATisfiability Module Theories (SMT) 101" />
<meta property="og:description" content="Finding bugs is hard, reverse engineering is hard. Constraint solvers are the heart of many program analysis techniques, and can aid Fuzzing, and software verification.
This post contains a few hands-on experiments with Z3, a high performance theorem prover developed at Microsoft Research by Leonardo de Moura and Nikolaj Bjorner. With KLEE, a Symbolic Execution Engine built on top of the LLVM compiler infrastructure developed by Cristian Cadar, Daniel Dunbar, and Dawson Engler." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://deniable.org/posts/symbolic-execution/" />
<meta property="article:published_time" content="2018-05-19T11:52:33+01:00" />
<meta property="article:modified_time" content="2018-05-19T11:52:33+01:00" /><meta property="og:site_name" content="shut up and hack" />


    <title>
  Practical Symbolic Execution and SATisfiability Module Theories (SMT) 101 Â· shut up and hack
</title>

    
      <link rel="canonical" href="http://deniable.org/posts/symbolic-execution/">
    

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css"
      integrity="sha256-gsmEoJAws/Kd3CjuOQzLie5Q3yshhvmo7YNtBG7aaEY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8/normalize.min.css">
    
      
      
      <link rel="stylesheet" href="/css/coder.min.15d3dcd7d56ff7df8a54a0659da83058d38fb1814fa8dad387efc92034b70def.css" integrity="sha256-FdPc19Vv99&#43;KVKBlnagwWNOPsYFPqNrTh&#43;/JIDS3De8=" crossorigin="anonymous" media="screen" />
    

    

    
      
        
        
        <link rel="stylesheet" href="/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css" integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin="anonymous" media="screen" />
      
    

    

    

    <link rel="icon" type="image/png" href="/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="/images/favicon-16x16.png" sizes="16x16">

    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

    

    <meta name="generator" content="Hugo 0.74.3" />
  </head>

  
  
    
  
  <body class="colorscheme-dark"
        onload=""
  >
    
<div class="float-container">
    <a id="dark-mode-toggle" class="colorscheme-toggle">
        <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
    </a>
</div>


    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="/">
      shut up and hack
    </a>
    
      <input type="checkbox" id="menu-toggle" />
      <label class="menu-button float-right" for="menu-toggle">
        <i class="fa fa-bars fa-fw" aria-hidden="true"></i>
      </label>
      <ul class="navigation-list">
        
          
            <li class="navigation-item">
              <a class="navigation-link" href="/posts/">Blog</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/projects">Projects</a>
            </li>
          
            <li class="navigation-item">
              <a class="navigation-link" href="/about">About</a>
            </li>
          
        
        
      </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">Practical Symbolic Execution and SATisfiability Module Theories (SMT) 101</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fa fa-calendar" aria-hidden="true"></i>
              <time datetime='2018-05-19T11:52:33&#43;01:00'>
                May 19, 2018
              </time>
            </span>
            <span class="reading-time">
              <i class="fa fa-clock-o" aria-hidden="true"></i>
              69-minute read
            </span>
          </div>
          
          
          
        </div>
      </header>

      <div>
        
        <p>Finding bugs is hard, reverse engineering is hard. Constraint solvers are the heart of many program analysis techniques, and can aid Fuzzing, and software verification.</p>
<p>This post contains a few hands-on experiments with <a href="https://github.com/Z3Prover/z3">Z3</a>, a high performance theorem prover developed at <a href="https://www.microsoft.com/en-us/research/">Microsoft Research</a> by <a href="https://leodemoura.github.io/">Leonardo de Moura</a> and <a href="https://www.microsoft.com/en-us/research/people/nbjorner/">Nikolaj Bjorner</a>. With <a href="https://klee.github.io/">KLEE</a>, a Symbolic Execution Engine built on top of the <a href="https://llvm.org/">LLVM compiler</a> infrastructure developed by <a href="https://www.doc.ic.ac.uk/~cristic/">Cristian Cadar</a>, <a href="http://minormatter.com/zr/">Daniel Dunbar</a>, and <a href="http://web.stanford.edu/~engler/">Dawson Engler</a>. And, <a href="http://angr.io/">angr</a>, a binary analysis framework developed by the <a href="https://seclab.cs.ucsb.edu/">Computer Security Lab at UC Santa Barbara</a> and their associated CTF team, <a href="https://github.com/shellphish">Shellphish</a>.</p>
<p>The motivation behind this post is basically to use it as reminder to myself. I couldn&rsquo;t keep using google to search for the same things/references over and over. Eventually in the future I&rsquo;ll post more realistic and advanced use case scenarios for the tools mentioned above, and a few others in this area that I&rsquo;m currently working on (meaning, trying to learn). However, this post was already too long.</p>
<p>To illustrate the use of Z3 I will mainly use its Python API because is practical and easy to understand. SAT/SMT solvers have many applications. An important application of SMT solvers is symbolic execution for analysis and testing of programs (concolic testing). The goal? Finding security vulnerabilities. That&rsquo;s exactly my main interest here.</p>
<p><img src="/z3/sat1.png" alt=""></p>
<p>A major problem you may find when you look at this subject is the fact that most of the information you&rsquo;ll find is too theoretical. However, many security researchers have already been working on this field for a long time. Symbolic execution can definitely help with Reverse Engineering and software analysis as you&rsquo;ll see if you follow this post.</p>
<p>The main reason this topic is getting in voga again, I believe, is mainly because computers are getting faster, and faster, and software is getting highly complex. Consequently, solving problems with SAT/SMT is more attractive now. If you want to go deep on the topic see the &ldquo;references&rdquo; section at the end of the article, you&rsquo;ll find awesome work on this subject that goes back more than 10 years. Notably, besides academia, as far as I know, <a href="https://twitter.com/richinseattle">Richard &lsquo;@richinseattle&rsquo; Johnson</a> was one of the first to start applying these techniques to bug finding while he was at Sourcefire (now Cisco).</p>
<h2 id="satsmt-solvers">SAT/SMT Solvers</h2>
<p>I wouldn&rsquo;t be able to define SAT/SMT better than wikipedia. So here&rsquo;s the <a href="https://en.wikipedia.org/wiki/Satisfiability_modulo_theories">wikipedia definition</a>.</p>
<p><em>In computer science and mathematical logic, the satisfiability modulo theories (SMT) problem is a decision problem for logical formulas with respect to combinations of background theories expressed in classical first-order logic with equality. Examples of theories typically used in computer science are the theory of real numbers, the theory of integers, and the theories of various data structures such as lists, arrays, bit vectors and so on. SMT can be thought of as a form of the constraint satisfaction problem and thus a certain formalized approach to constraint programming.</em></p>
<p>An SMT instance is a generalization of a Boolean SAT instance. I&rsquo;ll try to stay away from the theory and math behind SAT/SMT solvers. Not only because I&rsquo;m not at the academia anymore (and actually I didn&rsquo;t really study this subjects while I was there), but also because you&rsquo;ll be bored. So basically I&rsquo;ll show a few practical examples of how to use SAT/SMT solvers. I&rsquo;ll mainly use Z3, but there are a lot more SMT solvers, check this <a href="https://en.wikipedia.org/wiki/Satisfiability_modulo_theories#SMT_solvers">wikipedia page</a> for an eventually complete list.</p>
<p>Before diving into equations (SAT/SMT solvers are &lsquo;solvers&rsquo; of huge equations), you must be familiar with computer science logic. This is a prerequisite, so I won&rsquo;t be talking here about what&rsquo;s a variable, what&rsquo;s true (1) and false (0), what&rsquo;s <code>OR, XOR, AND</code>, and so on. If you feel rusty and you need some refreshing about these concepts wikipedia might be a good <a href="https://en.wikipedia.org/wiki/Logic_in_computer_science">starting point</a>. You&rsquo;ll also need to be familiar with other concepts like functions, connectives <code>(&amp;&amp;, ||, !)</code>, asserts (an assertion is always assumed to be true, if an assertion evaluates to false the program must end), and a few others.</p>
<p>So, an SMT problem is a decision problem for formulas expressed using logic that return true or false based in theories of arithmetic, lists, bit vectors, arrays, etc. In other words, an SMT solver is a constraint solver. What is a constraint? A statement that specifies properties of a solution to be found. A good example is&hellip; <a href="https://github.com/Z3Prover/z3">Z3</a>.</p>
<p>How solvers work? Magic? Well, kind of.</p>
<ul>
<li>user specifies a formula that must be satisfied</li>
<li>solver attempts to find a solution that SATisfies the formula</li>
</ul>
<p>If the solver can find a solution, the formula is said to be SATisfiable. If the solver cannot find a solution, the formula is said to be UNSATisfiable.</p>
<h2 id="z3">Z3</h2>
<h3 id="quick-z3-setup">Quick Z3 Setup</h3>
<p>To get started I recommend you to grab the code from the project&rsquo;s <a href="https://github.com/Z3Prover/z3">GitHub official repository</a>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ git clone https://github.com/Z3Prover/z3
$ <span style="color:#fff;font-weight:bold">cd</span> z3
$ CXX=clang++ CC=clang python scripts/mk_make.py
$ <span style="color:#fff;font-weight:bold">cd</span> build
$ make
$ sudo make install
</code></pre></div><p>After <code>make</code> Z3 Python scripts can already be executed in the <code>build/python</code> directory.</p>
<p>If you prefer to use a docker container just type:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker pull fdiskyou/z3:0.1
</code></pre></div><h3 id="linear-equation-with-3-variables">Linear equation with 3 variables</h3>
<p>As we learnt at primary school, real world problems can be represented as equations. So let&rsquo;s just use one of those equations we learnt somewhere around the 7th or 8th school year.</p>
<p>We&rsquo;ll use the following linear equation system with 3 variables, that I grabbed from <a href="http://tutorial.math.lamar.edu/Classes/Alg/SystemsThreeVrble.aspx">http://tutorial.math.lamar.edu</a>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">x - 2y + 3z = 7
2x + y + z = 4
-3x + 2y - 2z = -10
</code></pre></div><p>How can we solve this using Z3? Easy-peasy. If we use the Python bindings it&rsquo;s actually easy to read the code and understand what&rsquo;s going on.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007f7f">#!/usr/bin/python</span>

<span style="color:#fff;font-weight:bold">from</span> z3 <span style="color:#fff;font-weight:bold">import</span> *

s = Solver()

x = Int(<span style="color:#0ff;font-weight:bold">&#39;x&#39;</span>)
y = Int(<span style="color:#0ff;font-weight:bold">&#39;y&#39;</span>)
z = Int(<span style="color:#0ff;font-weight:bold">&#39;z&#39;</span>)

s.add(x - <span style="color:#ff0;font-weight:bold">2</span>*y + <span style="color:#ff0;font-weight:bold">3</span>*z == <span style="color:#ff0;font-weight:bold">7</span>)
s.add(<span style="color:#ff0;font-weight:bold">2</span>*x + y + z == <span style="color:#ff0;font-weight:bold">4</span>)
s.add(-<span style="color:#ff0;font-weight:bold">3</span>*x + <span style="color:#ff0;font-weight:bold">2</span>*y - <span style="color:#ff0;font-weight:bold">2</span>*z == -<span style="color:#ff0;font-weight:bold">10</span>)

<span style="color:#fff;font-weight:bold">print</span> s.check()
<span style="color:#fff;font-weight:bold">print</span> s.model()
</code></pre></div><p>The <code>Solver()</code> function solves a system of constraints. The function <code>Int('x')</code> creates an integer variable in Z3 named <code>x</code>. The example above uses 3 variables <code>x</code>, <code>y</code>, and <code>z</code>, and three constraints. In the example above, the expression <code>x - 2y + 3z = 7</code> is a Z3 constraint. Z3Py like Python uses <code>=</code> for assignment and the operators <code>&lt;, &lt;=, &gt;, &gt;=, ==</code> and <code>!=</code> for comparison.</p>
<p>You can try to solve the equation above by hand. You&rsquo;ll save a lot of time if you use Z3 though.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> python sample1.py
sat
[z = 1, x = 2, y = -1]

real    0m0.342s
user    0m0.265s
sys     0m0.036s
</code></pre></div><p>The <code>s.check()</code> returns <code>sat</code>, meaning Z3 was able to find the solution. If we change the equation in a way that it won&rsquo;t have a solution, it will return <code>unsat</code>. Since the equation was SATisfiable (in other words, has a solution) we got a model <code>(s.model())</code>.</p>
<p>I&rsquo;ve used <code>Int</code> because I only had integers in my equation. Obviously you can also have <code>Real</code> variables, <code>Bool</code>, and so on. Check the <a href="https://ericpony.github.io/z3py-tutorial/guide-examples.htm">z3py tutorial</a> and the <a href="https://rise4fun.com/z3/tutorial">Z3 guide</a> for more details.</p>
<p>As I said above, I&rsquo;m using Python because its practical and very popular among the &lsquo;hacker&rsquo; community. However, there&rsquo;s a standard language for SMT solvers called SMT-LIB. If I go back to the first example and re-write it, it will look like this:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">(declare-const x Int)
(declare-const y Int)
(declare-const z Int)

(<span style="color:#fff;font-weight:bold">assert</span>(=(+(- x (* <span style="color:#ff0;font-weight:bold">2</span> y)) (* <span style="color:#ff0;font-weight:bold">3</span> z)) <span style="color:#ff0;font-weight:bold">7</span>))
(<span style="color:#fff;font-weight:bold">assert</span>(=(+(+(* <span style="color:#ff0;font-weight:bold">2</span> x) y) z) <span style="color:#ff0;font-weight:bold">4</span>))
(<span style="color:#fff;font-weight:bold">assert</span>(=(-(-(* <span style="color:#ff0;font-weight:bold">2</span> y) (* <span style="color:#ff0;font-weight:bold">3</span> x)) (* <span style="color:#ff0;font-weight:bold">2</span> z)) -<span style="color:#ff0;font-weight:bold">10</span>))

(check-sat)
(get-model)
</code></pre></div><p>As you can see a lot more tricky, but still readable. We start by declaring constants, then we add constraints by adding assertions using <a href="https://en.wikipedia.org/wiki/Polish_notation">Polish notation</a>. Then we check the satisfiability (check-sat), and finally we get the interpretation that makes all formulas true (get-model).</p>
<p>If we save the code above in a file, we can run it as shown below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ z3 -smt2 sample1.smt
sat
(model
  (define-fun z () Int
    1)
  (define-fun x () Int
    2)
  (define-fun y () Int
    (- 1))
)
</code></pre></div><p>Z3 can also read commands from STDIN, just type instead:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ z3 -smt2 -in
</code></pre></div><p>Before we move on, see below a small UNSATisfiable example (in Python again).</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007f7f">#!/usr/bin/python</span>

<span style="color:#fff;font-weight:bold">from</span> z3 <span style="color:#fff;font-weight:bold">import</span> *

s = Solver()

a = Int(<span style="color:#0ff;font-weight:bold">&#39;a&#39;</span>)
b = Int(<span style="color:#0ff;font-weight:bold">&#39;b&#39;</span>)

s.add(a &gt; <span style="color:#ff0;font-weight:bold">0</span>)
s.add(a + <span style="color:#ff0;font-weight:bold">1</span> == b)
s.add(b &lt; <span style="color:#ff0;font-weight:bold">0</span>)

<span style="color:#fff;font-weight:bold">if</span> s.check() == unsat:
  <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#34;NO SOLUTION!&#34;</span>)
<span style="color:#fff;font-weight:bold">else</span>:
  <span style="color:#fff;font-weight:bold">print</span> s.model()
</code></pre></div><p>If we run it, we won&rsquo;t obviously get a solution.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ python sample3.py
NO SOLUTION!
</code></pre></div><p>This was only for demonstration purposes. If you want to fix the formula to make it SATisfiable, go ahead.</p>
<p>The basic examples above were enough to get us started. However, if you want to play with more complex equations/examples I recommend you, again, to look at:</p>
<ul>
<li><a href="https://ericpony.github.io/z3py-tutorial/guide-examples.htm">Z3 API in Python</a></li>
<li><a href="https://rise4fun.com/Z3/tutorial/guide">Getting Started with Z3: A Guide</a></li>
</ul>
<h3 id="puzzles">Puzzles</h3>
<p>If SAT/SMT solvers can be applied to equations, any kind of puzzle that you can describe as an equation can also be solved with Z3. You&rsquo;ll find many examples of puzzles solved with Z3. The best compilation that I&rsquo;m aware of is in the <a href="https://yurichev.com/writings/SAT_SMT_draft-EN.pdf">Quick introduction into SAT/SMT solvers and symbolic execution</a> by <a href="https://yurichev.com">Dennis Yurichev</a>. You definitely should look at this resource if you want to go deep on the subject.</p>
<p>Another good resource with plenty of solved puzzles can be found at <a href="https://github.com/0vercl0k/z3-playground">z3-playground</a>, maintained by Axel <a href="https://twitter.com/0vercl0k">@0vercl0k</a> Souchet.</p>
<h4 id="the-zebra-puzzle">The Zebra Puzzle</h4>
<p>As we can read on <a href="https://en.wikipedia.org/wiki/Zebra_Puzzle">wikipedia</a>, <em>The zebra puzzle is a well-known logic puzzle. Many versions of the puzzle exist, including a version published in Life International magazine on December 17, 1962.</em></p>
<p>This puzzle is often called Einstein&rsquo;s Riddle and you&rsquo;ll be able to find online some slight variations. Try to think how you can translate the problem into a data structure and then start adding your constraints. In my solution I used a matrix of integers.</p>
<p>You can find my solution below, and a different approach on <a href="https://yurichev.com/writings/SAT_SMT_draft-EN.pdf">Yurichev&rsquo;s pdf</a>. Axel Souchet used an <a href="https://github.com/0vercl0k/z3-playground/blob/master/einstein_riddle_z3.py">approach</a> very close to mine, even though a bit more elegant. Yurichev&rsquo;s might be the easiest to understand. Try to solve the puzzle yourself and then compare the solutions, there are many ways to solve the puzzle and you&rsquo;ll learn more that just looking at what others did. After all, this a good way to practice.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007f7f">#!/usr/bin/env python</span>
<span style="color:#0ff;font-weight:bold">&#39;&#39;&#39;
</span><span style="color:#0ff;font-weight:bold">My solution for: https://en.wikipedia.org/wiki/Zebra_Puzzle
</span><span style="color:#0ff;font-weight:bold">
</span><span style="color:#0ff;font-weight:bold">The following version of the puzzle appeared in Life International in 1962:
</span><span style="color:#0ff;font-weight:bold">
</span><span style="color:#0ff;font-weight:bold">0.  There are five houses.
</span><span style="color:#0ff;font-weight:bold">1.  The Englishman lives in the red house.
</span><span style="color:#0ff;font-weight:bold">2.  The Spaniard owns the dog.
</span><span style="color:#0ff;font-weight:bold">3.  Coffee is drunk in the green house.
</span><span style="color:#0ff;font-weight:bold">4.  The Ukrainian drinks tea.
</span><span style="color:#0ff;font-weight:bold">5.  The green house is immediately to the right of the ivory house.
</span><span style="color:#0ff;font-weight:bold">6.  The Old Gold smoker owns snails.
</span><span style="color:#0ff;font-weight:bold">7.  Kools are smoked in the yellow house.
</span><span style="color:#0ff;font-weight:bold">8.  Milk is drunk in the middle house.
</span><span style="color:#0ff;font-weight:bold">9.  The Norwegian lives in the first house.
</span><span style="color:#0ff;font-weight:bold">10. The man who smokes Chesterfields lives in the house next to the man with the fox.
</span><span style="color:#0ff;font-weight:bold">11. Kools are smoked in the house next to the house where the horse is kept.
</span><span style="color:#0ff;font-weight:bold">12. The Lucky Strike smoker drinks orange juice.
</span><span style="color:#0ff;font-weight:bold">13. The Japanese smokes Parliaments.
</span><span style="color:#0ff;font-weight:bold">14. The Norwegian lives next to the blue house.
</span><span style="color:#0ff;font-weight:bold">
</span><span style="color:#0ff;font-weight:bold">Now, who drinks water? Who owns the zebra?
</span><span style="color:#0ff;font-weight:bold">
</span><span style="color:#0ff;font-weight:bold">In the interest of clarity, it must be added that each of the five houses is painted a different color, and their inhabitants are of different national extractions, own different pets, drink different beverages and smoke different brands of American cigarets [sic]. One other thing: in statement 6, right means your right.
</span><span style="color:#0ff;font-weight:bold">&#39;&#39;&#39;</span>

<span style="color:#fff;font-weight:bold">from</span> z3 <span style="color:#fff;font-weight:bold">import</span> *

s = Solver()

zebra = {
         <span style="color:#0ff;font-weight:bold">&#39;color&#39;</span> : (<span style="color:#0ff;font-weight:bold">&#39;red&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;green&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;ivory&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;yellow&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>),
         <span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span> : (<span style="color:#0ff;font-weight:bold">&#39;British&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Spanish&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Ukrainian&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Norwegian&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Japanese&#39;</span>),
         <span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span> : (<span style="color:#0ff;font-weight:bold">&#39;dog&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;snail&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;zebra&#39;</span>),
         <span style="color:#0ff;font-weight:bold">&#39;beverage&#39;</span> : (<span style="color:#0ff;font-weight:bold">&#39;coffee&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;tea&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;milk&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;juice&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;water&#39;</span>),
         <span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span> : (<span style="color:#0ff;font-weight:bold">&#39;Old Gold&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Kools&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Lucky Strike&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Parliaments&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;Chesterfields&#39;</span>)
   }

<span style="color:#007f7f"># assign an integer/index to zebra[name] from 0 to 5</span>
color, nationality, pet, beverage, cigarets = <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) 

<span style="color:#007f7f"># Create Z3 integer variables for matrix cells</span>
cells = [ [ Int(<span style="color:#0ff;font-weight:bold">&#34;</span><span style="color:#0ff;font-weight:bold">%s</span><span style="color:#0ff;font-weight:bold">_</span><span style="color:#0ff;font-weight:bold">%d</span><span style="color:#0ff;font-weight:bold">&#34;</span> % (j, i)) <span style="color:#fff;font-weight:bold">for</span> j in zebra ] <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ]

<span style="color:#007f7f"># debug</span>
<span style="color:#007f7f">#print(cells)</span>

<span style="color:#007f7f"># Add cell constraints</span>
<span style="color:#fff;font-weight:bold">for</span> y in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>):
  <span style="color:#fff;font-weight:bold">for</span> x in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>):
    s.add(cells[x][y] &gt;= <span style="color:#ff0;font-weight:bold">0</span>, cells[x][y] &lt;= <span style="color:#ff0;font-weight:bold">4</span>)

<span style="color:#007f7f"># Add row constraints</span>
<span style="color:#fff;font-weight:bold">for</span> y in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>):
  s.add(Distinct([cells[x][y] <span style="color:#fff;font-weight:bold">for</span> x in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>)]))


<span style="color:#007f7f"># feed the solver with the hints above</span>

<span style="color:#007f7f"># The Englishman lives in the red house</span>
s.add( Or( [ And(cells[i][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;British&#39;</span>), cells[i][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;red&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) )

<span style="color:#007f7f"># The Spaniard owns the dog</span>
s.add( Or( [ And(cells[i][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Spanish&#39;</span>), cells[i][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;dog&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) )

<span style="color:#007f7f"># Coffee is drunk in the green house</span>
s.add( Or( [ And(cells[i][beverage] == zebra[<span style="color:#0ff;font-weight:bold">&#39;beverage&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;coffee&#39;</span>), cells[i][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;green&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) )

<span style="color:#007f7f"># The Ukrainian drinks tea</span>
s.add( Or( [ And(cells[i][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Ukrainian&#39;</span>), cells[i][beverage] == zebra[<span style="color:#0ff;font-weight:bold">&#39;beverage&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;tea&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) )

<span style="color:#007f7f"># The green house is immediately to the right of the ivory house</span>
s.add( Or( [ And(cells[i][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;green&#39;</span>), cells[i - <span style="color:#ff0;font-weight:bold">1</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;ivory&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) )

<span style="color:#007f7f"># The Old Gold smoker owns snails</span>
s.add( Or( [ And(cells[i][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Old Gold&#39;</span>), cells[i][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;snail&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) ) 

<span style="color:#007f7f"># Kools are smoked in the yellow house</span>
s.add( Or( [ And(cells[i][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Kools&#39;</span>), cells[i][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;yellow&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) )

<span style="color:#007f7f"># Milk is drunk in the middle house</span>
s.add(cells[<span style="color:#ff0;font-weight:bold">2</span>][beverage] == zebra[<span style="color:#0ff;font-weight:bold">&#39;beverage&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;milk&#39;</span>))

<span style="color:#007f7f"># The Norwegian lives in the first house</span>
s.add(cells[<span style="color:#ff0;font-weight:bold">0</span>][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Norwegian&#39;</span>))

<span style="color:#007f7f"># The man who smokes Chesterfields lives in the house next to the man with the fox</span>
s.add( Or(
  And(cells[<span style="color:#ff0;font-weight:bold">0</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Chesterfields&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">1</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>)),
  And(cells[<span style="color:#ff0;font-weight:bold">1</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Chesterfields&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">0</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">2</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">2</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Chesterfields&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">1</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">3</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">3</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Chesterfields&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">2</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">4</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">4</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Chesterfields&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">3</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;fox&#39;</span>)),
))

<span style="color:#007f7f"># Kools are smoked in the house next to the house where the horse is kept</span>
s.add( Or(
  And(cells[<span style="color:#ff0;font-weight:bold">0</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Kools&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">1</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>)),
  And(cells[<span style="color:#ff0;font-weight:bold">1</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Kools&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">0</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">2</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">2</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Kools&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">1</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">3</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">3</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Kools&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">2</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">4</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">4</span>][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Kools&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">3</span>][pet] == zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;horse&#39;</span>)),
))
 
<span style="color:#007f7f"># The Lucky Strike smoker drinks orange juice</span>
s.add( Or( [ And(cells[i][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Lucky Strike&#39;</span>), cells[i][beverage] == zebra[<span style="color:#0ff;font-weight:bold">&#39;beverage&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;juice&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) )

<span style="color:#007f7f"># The Japanese smokes Parliaments</span>
s.add( Or( [ And(cells[i][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Japanese&#39;</span>), cells[i][cigarets] == zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Parliaments&#39;</span>) ) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>) ] ) )

<span style="color:#007f7f"># The Norwegian lives next to the blue house</span>
s.add( Or(
  And(cells[<span style="color:#ff0;font-weight:bold">0</span>][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Norwegian&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">1</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>)),
  And(cells[<span style="color:#ff0;font-weight:bold">1</span>][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Norwegian&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">0</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">2</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">2</span>][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Norwegian&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">1</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">3</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">3</span>][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Norwegian&#39;</span>), Or(cells[<span style="color:#ff0;font-weight:bold">2</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">4</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>))),
  And(cells[<span style="color:#ff0;font-weight:bold">4</span>][nationality] == zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;Norwegian&#39;</span>), cells[<span style="color:#ff0;font-weight:bold">3</span>][color] == zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>].index(<span style="color:#0ff;font-weight:bold">&#39;blue&#39;</span>))
))

<span style="color:#fff;font-weight:bold">if</span> s.check() == unsat:
  <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;Failed to solve. Most likely some of the constraints are wrong.&#39;</span>) 

m = s.model()
solution = [[m[case].as_long() <span style="color:#fff;font-weight:bold">for</span> case in line] <span style="color:#fff;font-weight:bold">for</span> line in cells]

<span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">5</span>):
  <span style="color:#fff;font-weight:bold">print</span>(<span style="color:#0ff;font-weight:bold">&#39;House: </span><span style="color:#0ff;font-weight:bold">%s</span><span style="color:#0ff;font-weight:bold">, Nationality: </span><span style="color:#0ff;font-weight:bold">%s</span><span style="color:#0ff;font-weight:bold">, Beverage: </span><span style="color:#0ff;font-weight:bold">%s</span><span style="color:#0ff;font-weight:bold">, Smoke: </span><span style="color:#0ff;font-weight:bold">%s</span><span style="color:#0ff;font-weight:bold">, Pet: </span><span style="color:#0ff;font-weight:bold">%s</span><span style="color:#0ff;font-weight:bold">&#39;</span> % (
    zebra[<span style="color:#0ff;font-weight:bold">&#39;color&#39;</span>][solution[i][color]],
    zebra[<span style="color:#0ff;font-weight:bold">&#39;nationality&#39;</span>][solution[i][nationality]],
    zebra[<span style="color:#0ff;font-weight:bold">&#39;beverage&#39;</span>][solution[i][beverage]],
    zebra[<span style="color:#0ff;font-weight:bold">&#39;cigarets&#39;</span>][solution[i][cigarets]],
    zebra[<span style="color:#0ff;font-weight:bold">&#39;pet&#39;</span>][solution[i][pet]]
  ))
</code></pre></div><p>Compare the results to the ones at <a href="https://en.wikipedia.org/wiki/Zebra_Puzzle">wikipedia</a> even if you get a SAT result. Your constraints might be subtly &ldquo;wrong&rdquo; and the solution will be different.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> python zebra_puzzle.py
House: yellow, Nationality: Norwegian, Beverage: water, Smoke: Kools, Pet: fox
House: blue, Nationality: Ukrainian, Beverage: tea, Smoke: Chesterfields, Pet: horse
House: red, Nationality: British, Beverage: milk, Smoke: Old Gold, Pet: snail
House: ivory, Nationality: Spanish, Beverage: juice, Smoke: Lucky Strike, Pet: dog
House: green, Nationality: Japanese, Beverage: coffee, Smoke: Parliaments, Pet: zebra

real    0m0.469s
user    0m0.299s
sys     0m0.052s
</code></pre></div><h3 id="find-the-serial-number">Find the Serial Number</h3>
<p>Below is just a very simple example of a, let&rsquo;s say, &ldquo;program&rdquo; that validates a Serial Number. Nowadays, serial numbers validation routines are way more complex. But don&rsquo;t get too surprised if you are still able to find software that doesn&rsquo;t do any online validation and have all the logic implemented in the binary itself.</p>
<p>The idea here is just to show how Z3 can be used to generate a valid serial number given a <strong>known</strong> checking algorithm. This is not often the case, at most we might know what&rsquo;s the format of the Serial Number that a program expects. For example, the program tells you the SN is in the form <code>XXXXX-XXXXX</code>. In theory, based on the information we have we can brute force the SN. However, usually the program doesn&rsquo;t accept only one single combination of CHARs as a valid SN, but multiple valid combinations that must pass certain validation routines.</p>
<p>So what happens most of the times, including in CTFs (we&rsquo;ll get there after this example), is we reverse the program, and we try to locate the code that&rsquo;s responsible to validate our serial number. From there we try to figure what are the validations performed. In other words, what are the constraints. Most of the times the algorithm is complex and trying to solve it manualy is quite hard. That&rsquo;s when an SMT solver can come in handy.</p>
<p>We&rsquo;ll use a simple C program I wrote. The validation checks are very easy to understand, that&rsquo;s the idea. After this example we&rsquo;ll see an example from a CTF where we only have access to the binary itself so, we&rsquo;ll also need to do the reversing part.</p>
<p>Here&rsquo;s the code.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;stdlib.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;string.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">void</span> usage(<span style="color:#fff;font-weight:bold">char</span> *progname)
{
  printf(<span style="color:#0ff;font-weight:bold">&#34;Usage: %s &lt;serial number&gt;</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>, progname);
  printf(<span style="color:#0ff;font-weight:bold">&#34;Serial Number is the in the form XXXXX-XXXXX</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>);
  exit(<span style="color:#ff0;font-weight:bold">0</span>);
}

<span style="color:#fff;font-weight:bold">int</span> is_digit(<span style="color:#fff;font-weight:bold">int</span> d)
{
  <span style="color:#fff;font-weight:bold">if</span>(d &gt;= <span style="color:#ff0;font-weight:bold">48</span> &amp;&amp; d &lt;= <span style="color:#ff0;font-weight:bold">57</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">1</span>;

  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
}

<span style="color:#fff;font-weight:bold">int</span> is_char(<span style="color:#fff;font-weight:bold">int</span> d)
{
  <span style="color:#fff;font-weight:bold">if</span>(d &gt;= <span style="color:#ff0;font-weight:bold">65</span> &amp;&amp; d &lt;= <span style="color:#ff0;font-weight:bold">90</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">1</span>;

  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
}

<span style="color:#fff;font-weight:bold">int</span> validate_sn(<span style="color:#fff;font-weight:bold">char</span> *sn)
{
  <span style="color:#007f7f">// constraint 0: the whole SN has 11 chars
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">if</span> (strlen(sn) != <span style="color:#ff0;font-weight:bold">11</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;

  <span style="color:#007f7f">// constraint 1: index below must be equal to &#39;-&#39;
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">if</span>(sn[<span style="color:#ff0;font-weight:bold">5</span>] != <span style="color:#ff0;font-weight:bold">45</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;

  <span style="color:#007f7f">// constraint 2: the first char of first XXXXX sequence must be 1 and first char of second XXXXX sequence must be 5 
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">if</span>(sn[<span style="color:#ff0;font-weight:bold">0</span>] != <span style="color:#ff0;font-weight:bold">49</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
  <span style="color:#fff;font-weight:bold">if</span>(sn[<span style="color:#ff0;font-weight:bold">6</span>] != <span style="color:#ff0;font-weight:bold">53</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;

  <span style="color:#007f7f">// constraint 3: 2nd char is a digit, 7th char is digit
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">if</span>(is_digit(sn[<span style="color:#ff0;font-weight:bold">1</span>]) != <span style="color:#ff0;font-weight:bold">1</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
  <span style="color:#fff;font-weight:bold">if</span>(is_digit(sn[<span style="color:#ff0;font-weight:bold">7</span>]) != <span style="color:#ff0;font-weight:bold">1</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;

  <span style="color:#007f7f">// constraint 4: 3rd and 8th chars are uper case letters
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">if</span>(is_char(sn[<span style="color:#ff0;font-weight:bold">2</span>]) != <span style="color:#ff0;font-weight:bold">1</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>; 
  <span style="color:#fff;font-weight:bold">if</span>(is_char(sn[<span style="color:#ff0;font-weight:bold">8</span>]) != <span style="color:#ff0;font-weight:bold">1</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;

  <span style="color:#007f7f">// constraint 5: last 2 chars of every XXXXX are numbers
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">if</span>(is_digit(sn[<span style="color:#ff0;font-weight:bold">3</span>]) != <span style="color:#ff0;font-weight:bold">1</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
  <span style="color:#fff;font-weight:bold">if</span>(is_digit(sn[<span style="color:#ff0;font-weight:bold">4</span>]) != <span style="color:#ff0;font-weight:bold">1</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
  <span style="color:#fff;font-weight:bold">if</span>(is_digit(sn[<span style="color:#ff0;font-weight:bold">9</span>]) != <span style="color:#ff0;font-weight:bold">1</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
  <span style="color:#fff;font-weight:bold">if</span>(is_digit(sn[<span style="color:#ff0;font-weight:bold">10</span>]) != <span style="color:#ff0;font-weight:bold">1</span>)
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;

  <span style="color:#007f7f">// constraint 6: the last 2 chars of every XXXXX sequence must be the same
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">if</span>(sn[<span style="color:#ff0;font-weight:bold">3</span>] != sn[<span style="color:#ff0;font-weight:bold">4</span>])
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
  <span style="color:#fff;font-weight:bold">if</span>(sn[<span style="color:#ff0;font-weight:bold">9</span>] != sn[<span style="color:#ff0;font-weight:bold">10</span>])
    <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;

  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">1</span>;
}

<span style="color:#fff;font-weight:bold">int</span> main(<span style="color:#fff;font-weight:bold">int</span> argc, <span style="color:#fff;font-weight:bold">char</span> *argv[])
{
  <span style="color:#fff;font-weight:bold">char</span> *serial = argv[<span style="color:#ff0;font-weight:bold">1</span>];

  <span style="color:#fff;font-weight:bold">if</span> (argc &lt; <span style="color:#ff0;font-weight:bold">2</span>)
    usage(argv[<span style="color:#ff0;font-weight:bold">0</span>]);

  <span style="color:#fff;font-weight:bold">if</span> (validate_sn(serial))
    printf(<span style="color:#0ff;font-weight:bold">&#34;Thank You. Your license is now active.</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>);
  <span style="color:#fff;font-weight:bold">else</span>
    printf(<span style="color:#0ff;font-weight:bold">&#34;Invalid Serial Number. Please try again.</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>);

  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
}
</code></pre></div><p>The constraints are clearly identified in the source code. So let&rsquo;s see if we can &ldquo;ask&rdquo; Z3 to give us a valid serial number. See below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007f7f">#!/usr/bin/python</span>
<span style="color:#fff;font-weight:bold">import</span> sys
<span style="color:#fff;font-weight:bold">from</span> z3 <span style="color:#fff;font-weight:bold">import</span> *

s = Solver()

sn = IntVector(<span style="color:#0ff;font-weight:bold">&#39;sn&#39;</span>, <span style="color:#ff0;font-weight:bold">11</span>)

<span style="color:#fff;font-weight:bold">def</span> is_valid(x):
  <span style="color:#fff;font-weight:bold">return</span> Or(And(x &gt;= <span style="color:#ff0;font-weight:bold">0x41</span>, x &lt;= <span style="color:#ff0;font-weight:bold">0x5a</span>), And(x &gt;= <span style="color:#ff0;font-weight:bold">0x30</span>, x &lt;= <span style="color:#ff0;font-weight:bold">0x39</span>))

<span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">11</span>):
  <span style="color:#fff;font-weight:bold">if</span> (i != <span style="color:#ff0;font-weight:bold">5</span>):
    s.add(is_valid(sn[i]))

<span style="color:#007f7f"># constraint 1</span>
s.add(sn[<span style="color:#ff0;font-weight:bold">5</span>] == <span style="color:#ff0;font-weight:bold">0x2d</span>)

<span style="color:#007f7f"># constraint 2</span>
s.add(sn[<span style="color:#ff0;font-weight:bold">0</span>] == <span style="color:#ff0;font-weight:bold">0x31</span>)
s.add(sn[<span style="color:#ff0;font-weight:bold">6</span>] == <span style="color:#ff0;font-weight:bold">0x35</span>)

<span style="color:#007f7f"># constraint 3</span>
s.add(sn[<span style="color:#ff0;font-weight:bold">1</span>] &gt;= <span style="color:#ff0;font-weight:bold">0x30</span>, sn[<span style="color:#ff0;font-weight:bold">1</span>] &lt;= <span style="color:#ff0;font-weight:bold">0x39</span>)
s.add(sn[<span style="color:#ff0;font-weight:bold">7</span>] &gt;= <span style="color:#ff0;font-weight:bold">0x30</span>, sn[<span style="color:#ff0;font-weight:bold">7</span>] &lt;= <span style="color:#ff0;font-weight:bold">0x39</span>)

<span style="color:#007f7f"># constraint 4</span>
s.add(sn[<span style="color:#ff0;font-weight:bold">2</span>] &gt;= <span style="color:#ff0;font-weight:bold">0x41</span>, sn[<span style="color:#ff0;font-weight:bold">2</span>] &lt;= <span style="color:#ff0;font-weight:bold">0x5a</span>)
s.add(sn[<span style="color:#ff0;font-weight:bold">8</span>] &gt;= <span style="color:#ff0;font-weight:bold">0x41</span>, sn[<span style="color:#ff0;font-weight:bold">8</span>] &lt;= <span style="color:#ff0;font-weight:bold">0x5a</span>)

<span style="color:#007f7f"># constraint 5</span>
s.add(sn[<span style="color:#ff0;font-weight:bold">3</span>] &gt;= <span style="color:#ff0;font-weight:bold">0x30</span>, sn[<span style="color:#ff0;font-weight:bold">3</span>] &lt;= <span style="color:#ff0;font-weight:bold">0x39</span>)
s.add(sn[<span style="color:#ff0;font-weight:bold">4</span>] &gt;= <span style="color:#ff0;font-weight:bold">0x30</span>, sn[<span style="color:#ff0;font-weight:bold">4</span>] &lt;= <span style="color:#ff0;font-weight:bold">0x39</span>)
s.add(sn[<span style="color:#ff0;font-weight:bold">9</span>] &gt;= <span style="color:#ff0;font-weight:bold">0x30</span>, sn[<span style="color:#ff0;font-weight:bold">9</span>] &lt;= <span style="color:#ff0;font-weight:bold">0x39</span>)
s.add(sn[<span style="color:#ff0;font-weight:bold">10</span>] &gt;= <span style="color:#ff0;font-weight:bold">0x30</span>, sn[<span style="color:#ff0;font-weight:bold">10</span>] &lt;= <span style="color:#ff0;font-weight:bold">0x39</span>)

<span style="color:#007f7f"># constraint 6</span>
s.add(sn[<span style="color:#ff0;font-weight:bold">3</span>] == sn[<span style="color:#ff0;font-weight:bold">4</span>])
s.add(sn[<span style="color:#ff0;font-weight:bold">9</span>] == sn[<span style="color:#ff0;font-weight:bold">10</span>])

<span style="color:#fff;font-weight:bold">if</span> s.check() == unsat:
  <span style="color:#fff;font-weight:bold">print</span> <span style="color:#0ff;font-weight:bold">&#34;UNSAT&#34;</span>
  sys.exit()

m = s.model()

<span style="color:#fff;font-weight:bold">for</span> x in m:
  <span style="color:#fff;font-weight:bold">print</span> x, <span style="color:#fff;font-weight:bold">chr</span>(m[x].as_long())
</code></pre></div><p>And if we run it.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> python sn.py | sort -V
sn__0 <span style="color:#ff0;font-weight:bold">1</span>
sn__1 <span style="color:#ff0;font-weight:bold">0</span>
sn__2 A
sn__3 <span style="color:#ff0;font-weight:bold">0</span>
sn__4 <span style="color:#ff0;font-weight:bold">0</span>
sn__5 -
sn__6 <span style="color:#ff0;font-weight:bold">5</span>
sn__7 <span style="color:#ff0;font-weight:bold">0</span>
sn__8 A
sn__9 <span style="color:#ff0;font-weight:bold">0</span>
sn__10 <span style="color:#ff0;font-weight:bold">0</span>

real    0m0.332s
user    0m0.283s
sys     0m0.032s
</code></pre></div><p>We see that it found indeed a valid SN number according to the constraints we have defined. If we go back, and we test our <code>serial_validation</code> binary with the serial number that Z3 found for us, we get:</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ gcc -o serial_validation serial_validation.c
$ ./serial_validation
Usage: ./serial_validation &lt;serial number&gt;
Serial Number is the in the form XXXXX-XXXXX
$ ./serial_validation 10A00-50A00
Thank You. Your license is now active.
</code></pre></div><p>This a very contrived example. Hopefully, you tried to solve it and you (didn&rsquo;t) struggled a bit and were forced to learn at least a little more.</p>
<p>Before we talk about symbolic execution, let&rsquo;s try to solve a CTF challenge where we also have to find a valid serial number. Well, find a flag. But, you know what I mean.</p>
<h3 id="ctf-challenge-get-the-flag">CTF challenge (get the flag)</h3>
<p>We will try to solve a challenge from the <a href="http://codegate.org/en/">Codegate CTF 2018</a> Preliminary Round, more precisely the &ldquo;RedVelvet&rdquo; challenge (Reversing category).</p>
<p>We start by looking at the binary and run it.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ file RedVelvet
RedVelvet: ELF 64-bit LSB executable, x86-64, version <span style="color:#ff0;font-weight:bold">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, <span style="color:#fff;font-weight:bold">for</span> GNU/Linux 2.6.32, BuildID[sha1]=84e7ef91c33878cf9eefc00a7a450895aa573494, not stripped
$ ./RedVelvet
Your flag : aaa
</code></pre></div><p>The *nix strings utility only showed the interesting ASCII strings below. If you want to see the whole output check <a href="https://github.com/houseofxyz/symbolic-execution/blob/master/CTF-RedVelvet/strings.txt">here</a>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">HAPPINESS:)
Your flag :
flag : {&#34; %s &#34;}
</code></pre></div><p>So I opened the binary in IDA and looked at the main function.</p>
<p><img src="/z3/main.function.1.png" alt=""></p>
<p>It calls printf with <code>&quot;Your flag : &quot;</code>, calls <code>_fgets</code> to read our input, and then calls a bunch of functions always with the &ldquo;same&rdquo; parameters. These functions (func1, func2, funcX, &hellip;, func15) are for sure validating the flag.</p>
<p>If I look inside <code>func1</code> for example I can see it performs manipulations and comparisons based on the user input. If everything goes well the execution will continue, otherwise the execution will stop and the program exits.</p>
<p><img src="/z3/func1.png" alt=""></p>
<p>This is when IDA Pro Hex-Rays&rsquo; decompiler comes in handy. I pressed <code>F5</code> to see the pseudo-code.</p>
<p><img src="/z3/func1.pseudocode.png" alt=""></p>
<p>Much better. If the checks pass, the string <code>HAPPINESS:)</code> is printed and the code flows to the next function. If I look at <code>func2</code>, the story is the same.</p>
<p><img src="/z3/func2.pseudocode.png" alt=""></p>
<p>And the story goes on for all the other 13 functions. I also looked at the strings, even though as expected the solution is not there.</p>
<p><img src="/z3/strings.png" alt=""></p>
<p>If I follow the highlighted string above, I will end in a basic block near the end of the <code>main</code> function which will print the flag if I have provided the correct input.</p>
<p><img src="/z3/end.of.main.png" alt=""></p>
<p>This looks perfect for Z3, or even better for a symbolic execution framework. Let&rsquo;s stick with Z3 for now.</p>
<p>Well, we have everything we need to solve the challenge (I hope). So I&rsquo;ll copy all the pseudo code from the functions (from <code>func1</code>, to <code>func15</code>) and translate it to Z3 constraints. I&rsquo;ll start by simply replicating the functions in Python, which receives 2 arguments each (some will receive 3). I&rsquo;ll look at the remaining work after that.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func1(char a1, char a2)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 * 2 * (char)(a2 ^ a1) - a2 != 10858 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &lt;= 85 || a1 &gt; 95 || a2 &lt;= 96 || a2 &gt; 111 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func1(a1, a2):
  s.add(a1 * <span style="color:#ff0;font-weight:bold">2</span> * (a2 ^ a1) - a2 == <span style="color:#ff0;font-weight:bold">10858</span>)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">85</span>)
  s.add(a1 &lt;= <span style="color:#ff0;font-weight:bold">95</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">96</span> )
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">111</span>)
</code></pre></div><p>Hopefully, that&rsquo;s it. Note that I&rsquo;m reversing the logic because if the constraints above evaluate to true the program exits. And we&rsquo;ll be doing the same for another 14 functions. Whoever told you Reversing is fun, lied to you. It&rsquo;s actually quite boring, and persistence and patience are &lsquo;the&rsquo; master skill.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func2(char a1, char a2)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 % a2 != 7 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt;= 90 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func2(a1, a2):
  s.add(a1 % a2 == <span style="color:#ff0;font-weight:bold">7</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">90</span>)


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func3(char a1, char a2)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 / a2 + (char)(a2 ^ a1) != 21 || a1 &gt; 99 || a2 &gt; 119 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func3(a1, a2):
  s.add(a1 / a2 + (a2 ^ a1) == <span style="color:#ff0;font-weight:bold">21</span>)
  s.add(a1 &lt;= <span style="color:#ff0;font-weight:bold">99</span> )
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">119</span>)


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func4(char a1, char a2)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  signed __int64 v2; // rtt@1
</span><span style="color:#0ff;font-weight:bold">
</span><span style="color:#0ff;font-weight:bold">  LODWORD(v2) = (char)(a2 ^ a1 ^ a2);
</span><span style="color:#0ff;font-weight:bold">  HIDWORD(v2) = (unsigned __int64)(char)(a2 ^ a1 ^ a2) &gt;&gt; 32;
</span><span style="color:#0ff;font-weight:bold">  if ( (unsigned int)(v2 % a2) + a1 != 137 || a1 &lt;= 115 || a2 &gt; 99 || a2 != 95 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func4(a1, a2):
  v2 = a1 &lt;&lt; <span style="color:#ff0;font-weight:bold">32</span> | a1
  s.add((v2 % a2) + a1 == <span style="color:#ff0;font-weight:bold">137</span>)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">115</span>)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">99</span>)
  s.add(a2 == <span style="color:#ff0;font-weight:bold">95</span>)


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func5(char a1, char a2)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( ((a2 + a1) ^ (char)(a1 ^ a2 ^ a1)) != 225 || a1 &lt;= 90 || a2 &gt; 89 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func5(a1, a2):
  s.add((a1 + a2) ^ a2 == <span style="color:#ff0;font-weight:bold">225</span>)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">90</span> )
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">89</span> )


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func6(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &gt; a2 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &gt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &lt;= 85 || a2 &lt;= 110 || a3 &lt;= 115 || ((a2 + a3) ^ (a1 + a2)) != 44 || (a2 + a3) % a1 + a2 != 161 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func6(a1, a2, a3):
  s.add(a1 &lt;= a2)
  s.add(a2 &lt;= a3)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">85</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">110</span>)
  s.add(a3 &gt; <span style="color:#ff0;font-weight:bold">115</span>)
  s.add(((a2 + a3) ^ (a1 + a2)) == <span style="color:#ff0;font-weight:bold">44</span>)
  s.add(URem(a2 + a3, a1) + a2 == <span style="color:#ff0;font-weight:bold">161</span> ) <span style="color:#007f7f"># Use the function URem() for unsigned remainder, and SRem() for signed remainder. https://z3prover.github.io/api/html/classz3py_1_1_bit_vec_ref.html</span>


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func7(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &lt; a2 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &gt; 119 || a2 &lt;= 90 || a3 &gt; 89 || ((a1 + a3) ^ (a2 + a3)) != 122 || (a1 + a3) % a2 + a3 != 101 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func7(a1, a2, a3):
  s.add(a1 &gt;= a2)
  s.add(a2 &gt;= a3)
  s.add(a1 &lt;= <span style="color:#ff0;font-weight:bold">119</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">90</span>)
  s.add(a3 &lt;= <span style="color:#ff0;font-weight:bold">89</span>)
  s.add(((a1 + a3) ^ (a2 + a3)) == <span style="color:#ff0;font-weight:bold">122</span> )
  s.add(URem(a1 + a3,  a2) + a3 == <span style="color:#ff0;font-weight:bold">101</span>)


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func8(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &gt; a2 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &gt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a3 &gt; 114 || (a1 + a2) / a3 * a2 != 97 || (a3 ^ (a1 - a2)) * a2 != -10088 || a3 &gt; 114 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func8(a1, a2, a3):
  s.add(a1 &lt;= a2)
  s.add(a2 &lt;= a3)
  s.add( a3 &lt;= <span style="color:#ff0;font-weight:bold">114</span>)
  s.add( UDiv(a1 + a2, a3) * a2 == <span style="color:#ff0;font-weight:bold">97</span> ) <span style="color:#007f7f"># Use the function UDiv() for unsigned division. https://z3prover.github.io/api/html/classz3py_1_1_bit_vec_ref.html</span>
  s.add( a3 ^ (a1 - a2) == -<span style="color:#ff0;font-weight:bold">8</span>*<span style="color:#ff0;font-weight:bold">13</span>)


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func9(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 != a2 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a3 &gt; 99 || a3 + a1 * (a3 - a2) - a1 != -1443 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func9(a1, a2, a3):
  s.add(a1 == a2)
  s.add(a2 &gt;= a3)
  s.add(a3 &lt;= <span style="color:#ff0;font-weight:bold">99</span>)
  s.add(a3 + a1 * (a3 - a2) - a1 == -<span style="color:#ff0;font-weight:bold">1443</span>)


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func10(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &lt; a2 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 * (a1 + a3 + 1) - a3 != 15514 || a2 &lt;= 90 || a2 &gt; 99 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func10(a1, a2, a3):
  s.add(a1 &gt;= a2)
  s.add(a2 &gt;= a3)
  s.add(a2 * (a1 + a3 + <span style="color:#ff0;font-weight:bold">1</span>) - a3 == <span style="color:#ff0;font-weight:bold">15514</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">90</span>)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">99</span>)


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func11(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt; a1 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &lt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt;= 100 || a2 &gt; 104 || a1 + (a2 ^ (a2 - a3)) - a3 != 70 || (a2 + a3) / a1 + a1 != 68 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func11(a1, a2, a3):
  s.add(a2 &gt;= a1)
  s.add(a1 &gt;= a3)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">100</span>)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">104</span>)
  s.add(a1 + (a2 ^ (a2 - a3)) - a3 == <span style="color:#ff0;font-weight:bold">70</span>)
  s.add(UDiv(a2 + a3, a1) + a1 == <span style="color:#ff0;font-weight:bold">68</span> )


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func12(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &lt; a2 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &gt; 59 || a3 &gt; 44 || a1 + (a2 ^ (a3 + a2)) - a3 != 111 || (a2 ^ (a2 - a3)) + a2 != 101 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func12(a1, a2, a3):
  s.add(a1 &gt;= a2)
  s.add(a2 &gt;= a3)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">59</span>)
  s.add(a3 &lt;= <span style="color:#ff0;font-weight:bold">44</span>)
  s.add(a1 + (a2 ^ (a3 + a2)) - a3 == <span style="color:#ff0;font-weight:bold">111</span>)
  s.add((a2 ^ (a2 - a3)) + a2 == <span style="color:#ff0;font-weight:bold">101</span> )


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func13(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &gt; a2 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &gt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &lt;= 40 || a2 &lt;= 90 || a3 &gt; 109 || a3 + (a2 ^ (a3 + a1)) - a1 != 269 || (a3 ^ (a2 - a1)) + a2 != 185 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func13(a1, a2, a3):
  s.add(a1 &lt;= a2)
  s.add(a2 &lt;= a3)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">40</span> )
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">90</span> )
  s.add(a3 &lt;= <span style="color:#ff0;font-weight:bold">109</span>)
  s.add(a3 + (a2 ^ (a3 + a1)) - a1 == <span style="color:#ff0;font-weight:bold">269</span>)
  s.add((a3 ^ (a2 - a1)) + a2 == <span style="color:#ff0;font-weight:bold">185</span>)


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func14(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a1 &lt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &gt; 99 || a3 &lt;= 90 || a1 + (a2 ^ (a2 + a1)) - a3 != 185 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func14(a1, a2, a3):
  s.add(a1 &gt;= a3)
  s.add(a2 &gt;= a3)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">99</span>)
  s.add(a3 &gt; <span style="color:#ff0;font-weight:bold">90</span>)
  s.add(a1 + (a2 ^ (a2 + a1)) - a3 == <span style="color:#ff0;font-weight:bold">185</span> )


<span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;
</span><span style="color:#0ff;font-weight:bold">int __fastcall func15(char a1, char a2, char a3)
</span><span style="color:#0ff;font-weight:bold">{
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt; a3 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a2 &lt; a1 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  if ( a3 &lt;= 95 || a2 &gt; 109 || ((a2 - a1) * a2 ^ a3) - a1 != 1214 || ((a3 - a2) * a3 ^ a1) + a2 != -1034 )
</span><span style="color:#0ff;font-weight:bold">    exit(1);
</span><span style="color:#0ff;font-weight:bold">  return puts(&#34;HAPPINESS:)&#34;);
</span><span style="color:#0ff;font-weight:bold">}
</span><span style="color:#0ff;font-weight:bold">&#34;&#34;&#34;</span>
<span style="color:#fff;font-weight:bold">def</span> func15(a1, a2, a3):
  s.add(a2 &gt;= a3)
  s.add(a2 &gt;= a1)
  s.add(a3 &gt; <span style="color:#ff0;font-weight:bold">95</span>)
  s.add( a2 &lt;= <span style="color:#ff0;font-weight:bold">109</span>)
  s.add(((a2 - a1) * a2 ^ a3) - a1 == <span style="color:#ff0;font-weight:bold">1214</span>)
  s.add(((a3 - a2) * a3 ^ a1) + a2 == -<span style="color:#ff0;font-weight:bold">1034</span>)
</code></pre></div><p>Ok, that was the easiest part.</p>
<p>If we decompile the <code>main</code> function, we can see the following code.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#fff;font-weight:bold">int</span> <span style="color:#fff;font-weight:bold">__cdecl</span> main(<span style="color:#fff;font-weight:bold">int</span> argc, <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> **argv, <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> **envp)
{
  <span style="color:#fff;font-weight:bold">char</span> v3; <span style="color:#007f7f">// bl@0
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v4; <span style="color:#007f7f">// rax@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v5; <span style="color:#007f7f">// rcx@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v6; <span style="color:#007f7f">// rsi@2
</span><span style="color:#007f7f"></span>  size_t v7; <span style="color:#007f7f">// rax@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v9; <span style="color:#007f7f">// t1@8
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">bool</span> v10; <span style="color:#007f7f">// zf@8
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">signed</span> <span style="color:#fff;font-weight:bold">int</span> i; <span style="color:#007f7f">// [sp+8h] [bp-1B8h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v12; <span style="color:#007f7f">// [sp+50h] [bp-170h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> s; <span style="color:#007f7f">// [sp+C0h] [bp-100h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v14; <span style="color:#007f7f">// [sp+C1h] [bp-FFh]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v15; <span style="color:#007f7f">// [sp+C2h] [bp-FEh]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v16; <span style="color:#007f7f">// [sp+C3h] [bp-FDh]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v17; <span style="color:#007f7f">// [sp+C4h] [bp-FCh]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v18; <span style="color:#007f7f">// [sp+C5h] [bp-FBh]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v19; <span style="color:#007f7f">// [sp+C6h] [bp-FAh]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v20; <span style="color:#007f7f">// [sp+C7h] [bp-F9h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v21; <span style="color:#007f7f">// [sp+C8h] [bp-F8h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v22; <span style="color:#007f7f">// [sp+C9h] [bp-F7h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v23; <span style="color:#007f7f">// [sp+CAh] [bp-F6h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v24; <span style="color:#007f7f">// [sp+CBh] [bp-F5h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v25; <span style="color:#007f7f">// [sp+CCh] [bp-F4h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v26; <span style="color:#007f7f">// [sp+CDh] [bp-F3h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v27; <span style="color:#007f7f">// [sp+CEh] [bp-F2h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v28; <span style="color:#007f7f">// [sp+CFh] [bp-F1h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v29; <span style="color:#007f7f">// [sp+D0h] [bp-F0h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v30; <span style="color:#007f7f">// [sp+D1h] [bp-EFh]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v31; <span style="color:#007f7f">// [sp+D2h] [bp-EEh]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v32; <span style="color:#007f7f">// [sp+D3h] [bp-EDh]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v33; <span style="color:#007f7f">// [sp+D4h] [bp-ECh]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v34; <span style="color:#007f7f">// [sp+D5h] [bp-EBh]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v35; <span style="color:#007f7f">// [sp+D6h] [bp-EAh]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v36; <span style="color:#007f7f">// [sp+D7h] [bp-E9h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v37; <span style="color:#007f7f">// [sp+D8h] [bp-E8h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v38; <span style="color:#007f7f">// [sp+D9h] [bp-E7h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> v39[<span style="color:#ff0;font-weight:bold">32</span>]; <span style="color:#007f7f">// [sp+E0h] [bp-E0h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> s1[<span style="color:#ff0;font-weight:bold">80</span>]; <span style="color:#007f7f">// [sp+100h] [bp-C0h]@3
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> s2[<span style="color:#ff0;font-weight:bold">8</span>]; <span style="color:#007f7f">// [sp+150h] [bp-70h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v42; <span style="color:#007f7f">// [sp+158h] [bp-68h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v43; <span style="color:#007f7f">// [sp+160h] [bp-60h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v44; <span style="color:#007f7f">// [sp+168h] [bp-58h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v45; <span style="color:#007f7f">// [sp+170h] [bp-50h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v46; <span style="color:#007f7f">// [sp+178h] [bp-48h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v47; <span style="color:#007f7f">// [sp+180h] [bp-40h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v48; <span style="color:#007f7f">// [sp+188h] [bp-38h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v49; <span style="color:#007f7f">// [sp+190h] [bp-30h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v50; <span style="color:#007f7f">// [sp+198h] [bp-28h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v51; <span style="color:#007f7f">// [sp+1A0h] [bp-20h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v52; <span style="color:#007f7f">// [sp+1A8h] [bp-18h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">int</span> v53; <span style="color:#007f7f">// [sp+1B0h] [bp-10h]@1
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">__int64</span> v54; <span style="color:#007f7f">// [sp+1B8h] [bp-8h]@1
</span><span style="color:#007f7f"></span>
  v54 = *MK_FP(__FS__, <span style="color:#ff0;font-weight:bold">40LL</span>);
  *(_QWORD *)s2 = <span style="color:#ff0;font-weight:bold">3905859155515433264LL</span>;
  v42 = <span style="color:#ff0;font-weight:bold">3990529441497888818LL</span>;
  v43 = <span style="color:#ff0;font-weight:bold">7017565014431380534LL</span>;
  v44 = <span style="color:#ff0;font-weight:bold">3977633058323522358LL</span>;
  v45 = <span style="color:#ff0;font-weight:bold">7364290724313116725LL</span>;
  v46 = <span style="color:#ff0;font-weight:bold">3991705742141175652LL</span>;
  v47 = <span style="color:#ff0;font-weight:bold">7363494672811320633LL</span>;
  v48 = <span style="color:#ff0;font-weight:bold">3847534474596595814LL</span>;
  v49 = <span style="color:#ff0;font-weight:bold">0LL</span>;
  v50 = <span style="color:#ff0;font-weight:bold">0LL</span>;
  v51 = <span style="color:#ff0;font-weight:bold">0LL</span>;
  v52 = <span style="color:#ff0;font-weight:bold">0LL</span>;
  v53 = <span style="color:#ff0;font-weight:bold">0</span>;
  printf((<span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> *)&amp;loc_4016CF + <span style="color:#ff0;font-weight:bold">1</span>, argv, envp);
  fgets(&amp;s, <span style="color:#ff0;font-weight:bold">27</span>, edata);
  func1(s, v14);
  func2(v14, v15);
  func3(v15, v16);
  func4(v16, v17);
  func5(v17, v18);
  func6(v18, v19, v20);
  func7(v20, v21, v22);
  func8(v22, v23, v24);
  func9(v24, v25, v26);
  v4 = ptrace(<span style="color:#ff0;font-weight:bold">0</span>, <span style="color:#ff0;font-weight:bold">0LL</span>, <span style="color:#ff0;font-weight:bold">1LL</span>, <span style="color:#ff0;font-weight:bold">0LL</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( v4 == -<span style="color:#ff0;font-weight:bold">1</span> )
  {
    v9 = *(_BYTE *)v5;
    v10 = v3 + *(_BYTE *)(v5 + <span style="color:#ff0;font-weight:bold">111</span>) == <span style="color:#ff0;font-weight:bold">0</span>;
    *(_BYTE *)(v5 + <span style="color:#ff0;font-weight:bold">111</span>) += v3;
    JUMPOUT(!v10, &amp;unk_401746);
    v6C &amp;= BYTE1(v4);
    JUMPOUT(*(_QWORD *)<span style="color:#0ff;font-weight:bold">&#34;ag : &#34;</span>);
  }
  func10(v26, v27, v28);
  func11(v28, v29, v30);
  func12(v30, v31, v32);
  func13(v32, v33, v34);
  func14(v34, v35, v36);
  v6 = (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)v37;
  func15(v36, v37, v38);
  SHA256_Init(&amp;v12, v6);
  v7 = strlen(&amp;s);
  SHA256_Update(&amp;v12, &amp;s, v7);
  SHA256_Final(v39, &amp;v12);
  <span style="color:#fff;font-weight:bold">for</span> ( i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt;= <span style="color:#ff0;font-weight:bold">31</span>; ++i )
    sprintf(&amp;s1[<span style="color:#ff0;font-weight:bold">2</span> * i], <span style="color:#0ff;font-weight:bold">&#34;%02x&#34;</span>, (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">__int8</span>)v39[i]);
  <span style="color:#fff;font-weight:bold">if</span> ( strcmp(s1, s2) )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  printf(<span style="color:#0ff;font-weight:bold">&#34;flag : {</span><span style="color:#0ff;font-weight:bold">\&#34;</span><span style="color:#0ff;font-weight:bold"> %s </span><span style="color:#0ff;font-weight:bold">\&#34;</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>, &amp;s);
  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
}
</code></pre></div><p>If we look at the line where our input is read, we know that the flag is supposed to have at maximum 27 chars (including the final null terminator).</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">fgets(&amp;s, 27, edata);
</code></pre></div><p>It is also important to look at which chars are passed to each function. We saw that some <code>funcX</code> functions receive 2 chars, other 3 chars. If we look at the pseudo code of the function <code>main</code>, we can also figure which chars are passed to each function.</p>
<p>So, anyway I need to define which chars I will accept as valid. I&rsquo;ll consider the following chars only. If for some reason I can&rsquo;t get a solution, I&rsquo;ll expand it.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_!@#$%^&amp;*?:)(
</code></pre></div><p>I add the following to my Z3 python script.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">def</span> is_valid(x):
  <span style="color:#fff;font-weight:bold">return</span> Or(And(x &gt;= <span style="color:#ff0;font-weight:bold">65</span>, x &lt;= <span style="color:#ff0;font-weight:bold">90</span>), And(x &gt;= <span style="color:#ff0;font-weight:bold">97</span>, x &lt;= <span style="color:#ff0;font-weight:bold">122</span>), And(x &gt;= <span style="color:#ff0;font-weight:bold">48</span>, x &lt;= <span style="color:#ff0;font-weight:bold">57</span>), And(x == <span style="color:#ff0;font-weight:bold">95</span>), And(x == <span style="color:#ff0;font-weight:bold">33</span>), And(x == <span style="color:#ff0;font-weight:bold">64</span>), And(x == <span style="color:#ff0;font-weight:bold">35</span>), And(x == <span style="color:#ff0;font-weight:bold">36</span>), And(x == <span style="color:#ff0;font-weight:bold">37</span>), And(x == <span style="color:#ff0;font-weight:bold">94</span>), And(x == <span style="color:#ff0;font-weight:bold">38</span>), And(x == <span style="color:#ff0;font-weight:bold">42</span>), And(x == <span style="color:#ff0;font-weight:bold">63</span>), And(x == <span style="color:#ff0;font-weight:bold">58</span>), And(x == <span style="color:#ff0;font-weight:bold">40</span>), And(x == <span style="color:#ff0;font-weight:bold">41</span>))

x = [ BitVec(<span style="color:#0ff;font-weight:bold">&#39;a</span><span style="color:#0ff;font-weight:bold">%i</span><span style="color:#0ff;font-weight:bold">&#39;</span> % i, <span style="color:#ff0;font-weight:bold">32</span>) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">26</span>) ]

<span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">26</span>):
  s.add(is_valid(x[i]))
</code></pre></div><p>As you can see above I create a <code>BitVec</code> and I initialize it. With size 26 because we saw the input string would take 26 chars above (excluding the null char terminator of <code>C</code> strings).</p>
<p>Based on the logic I got from the <code>main</code> function pseudo code I add the following to my Z3 python script.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">func1(x[<span style="color:#ff0;font-weight:bold">0</span>], x[<span style="color:#ff0;font-weight:bold">1</span>])
func2(x[<span style="color:#ff0;font-weight:bold">1</span>], x[<span style="color:#ff0;font-weight:bold">2</span>])
func3(x[<span style="color:#ff0;font-weight:bold">2</span>], x[<span style="color:#ff0;font-weight:bold">3</span>])
func4(x[<span style="color:#ff0;font-weight:bold">3</span>], x[<span style="color:#ff0;font-weight:bold">4</span>])
func5(x[<span style="color:#ff0;font-weight:bold">4</span>], x[<span style="color:#ff0;font-weight:bold">5</span>])
func6(x[<span style="color:#ff0;font-weight:bold">5</span>], x[<span style="color:#ff0;font-weight:bold">6</span>], x[<span style="color:#ff0;font-weight:bold">7</span>])
func7(x[<span style="color:#ff0;font-weight:bold">7</span>], x[<span style="color:#ff0;font-weight:bold">8</span>], x[<span style="color:#ff0;font-weight:bold">9</span>])
func8(x[<span style="color:#ff0;font-weight:bold">9</span>], x[<span style="color:#ff0;font-weight:bold">10</span>], x[<span style="color:#ff0;font-weight:bold">11</span>])
func9(x[<span style="color:#ff0;font-weight:bold">11</span>], x[<span style="color:#ff0;font-weight:bold">12</span>], x[<span style="color:#ff0;font-weight:bold">13</span>])
func10(x[<span style="color:#ff0;font-weight:bold">13</span>], x[<span style="color:#ff0;font-weight:bold">14</span>], x[<span style="color:#ff0;font-weight:bold">15</span>])
func11(x[<span style="color:#ff0;font-weight:bold">15</span>], x[<span style="color:#ff0;font-weight:bold">16</span>], x[<span style="color:#ff0;font-weight:bold">17</span>])
func12(x[<span style="color:#ff0;font-weight:bold">17</span>], x[<span style="color:#ff0;font-weight:bold">18</span>], x[<span style="color:#ff0;font-weight:bold">19</span>])
func13(x[<span style="color:#ff0;font-weight:bold">19</span>], x[<span style="color:#ff0;font-weight:bold">20</span>], x[<span style="color:#ff0;font-weight:bold">21</span>])
func14(x[<span style="color:#ff0;font-weight:bold">21</span>], x[<span style="color:#ff0;font-weight:bold">22</span>], x[<span style="color:#ff0;font-weight:bold">23</span>])
func15(x[<span style="color:#ff0;font-weight:bold">23</span>], x[<span style="color:#ff0;font-weight:bold">24</span>], x[<span style="color:#ff0;font-weight:bold">25</span>])
</code></pre></div><p>And I should be ready to go. I only need to print the &ldquo;solution&rdquo;.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">if</span> (s.check() == sat):
  solution = s.model()
  flag = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>
  <span style="color:#fff;font-weight:bold">for</span> n in x:
      char = solution[n].as_long()
      flag += <span style="color:#fff;font-weight:bold">chr</span>(char)
  <span style="color:#fff;font-weight:bold">print</span> flag
<span style="color:#fff;font-weight:bold">else</span>:
  <span style="color:#fff;font-weight:bold">print</span> <span style="color:#0ff;font-weight:bold">&#34;UNSAT: go back and check your constraints&#34;</span>
</code></pre></div><p>If I run it.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> python red_velvet.py
What_You_Wanna_Be?:)_lc_la

real    0m0.878s
user    0m0.845s
sys     0m0.032s
</code></pre></div><p>Wow, apparently it works. It took me close to an hour to put this together but the execution is really fast. Let&rsquo;s validate the solution.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ./RedVelvet
Your flag : What_You_Wanna_Be?:)_lc_la
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
</code></pre></div><p>Hmm, we have 15 <code>HAPPINESS:)</code> strings printed but apparently the solution is not the one expected. Why? If we look at the pseudo code of the main function we&rsquo;ll see that after all the validations a <code>SHA256</code> hash is computed and the result apparently is different. Don&rsquo;t panic. We know that solvers can give us more than one valid solution.</p>
<p>What we need to do is ask Z3 to give as another satisfying model. If we don&rsquo;t want to find all possible solutions, and we are just feeling lazy we could do something like this.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">while</span> (s.check() == sat):
  solution = s.model()
  flag = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>
  <span style="color:#fff;font-weight:bold">for</span> n in x:
      char = solution[n].as_long()
      flag += <span style="color:#fff;font-weight:bold">chr</span>(char)
  <span style="color:#fff;font-weight:bold">print</span> flag
  s.add(Or(solution != s.model()))
<span style="color:#fff;font-weight:bold">else</span>:
  <span style="color:#fff;font-weight:bold">print</span> <span style="color:#0ff;font-weight:bold">&#34;UNSAT: go back and check your constraints&#34;</span>
</code></pre></div><p>I&rsquo;m not using any kind of finite sorts and this is not the proper way to do it. But I can run it and just get another possible solution.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ python red_velvet.py
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
^C
</code></pre></div><p>However, what we should do is add a new constraint that blocks the model returned by Z3. The solution below still has some <a href="https://stackoverflow.com/questions/11867611/z3py-checking-all-solutions-for-equation">limitations</a> but should work for us.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">while</span> s.check() == sat:
  solution = s.model()
  block = []
  <span style="color:#fff;font-weight:bold">for</span> d in solution:
    c = d()
    block.append(c != solution[d])
    flag = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>
    <span style="color:#fff;font-weight:bold">for</span> n in x:
      char = solution[n].as_long()
      flag += <span style="color:#fff;font-weight:bold">chr</span>(char)
    <span style="color:#fff;font-weight:bold">print</span> flag
  s.add(Or(block))
</code></pre></div><p>If we run it now.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> python red_velvet.py
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_lc_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lb_la

real    0m2.200s
user    0m2.131s
sys     0m0.060s
</code></pre></div><p>Ok, let&rsquo;s sort this.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ python red_velvet.py | sort -u
What_You_Wanna_Be?:)_la_la
What_You_Wanna_Be?:)_lb_la
What_You_Wanna_Be?:)_lc_la
</code></pre></div><p>Apparently we have 3 possible solutions (actually more if we expand the accepted charset). Let&rsquo;s try them and see if we are luckier this time, and we don&rsquo;t get stopped by the hash validation routine.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ./RedVelvet
Your flag : What_You_Wanna_Be?:)_la_la
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
flag : {<span style="color:#0ff;font-weight:bold">&#34; What_You_Wanna_Be?:)_la_la &#34;</span>}
</code></pre></div><p>Cool. So <code>What_You_Wanna_Be?:)_la_la</code> is the solution, and the solver gave us 3 possible solutions. Keep this in mind.</p>
<p>The final version of the script is below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">from</span> z3 <span style="color:#fff;font-weight:bold">import</span> *

<span style="color:#fff;font-weight:bold">def</span> func1(a1, a2):
  s.add(a1 * <span style="color:#ff0;font-weight:bold">2</span> * (a2 ^ a1) - a2 == <span style="color:#ff0;font-weight:bold">10858</span>)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">85</span>)
  s.add(a1 &lt;= <span style="color:#ff0;font-weight:bold">95</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">96</span> )
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">111</span>)

<span style="color:#fff;font-weight:bold">def</span> func2(a1, a2):
  s.add(a1 % a2 == <span style="color:#ff0;font-weight:bold">7</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">90</span>)

<span style="color:#fff;font-weight:bold">def</span> func3(a1, a2):
  s.add(a1 / a2 + (a2 ^ a1) == <span style="color:#ff0;font-weight:bold">21</span>)
  s.add(a1 &lt;= <span style="color:#ff0;font-weight:bold">99</span> )
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">119</span>)

<span style="color:#fff;font-weight:bold">def</span> func4(a1, a2):
  v2 = a1 &lt;&lt; <span style="color:#ff0;font-weight:bold">32</span> | a1
  s.add((v2 % a2) + a1 == <span style="color:#ff0;font-weight:bold">137</span>)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">115</span>)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">99</span>)
  s.add(a2 == <span style="color:#ff0;font-weight:bold">95</span>)

<span style="color:#fff;font-weight:bold">def</span> func5(a1, a2):
  s.add((a1 + a2) ^ a2 == <span style="color:#ff0;font-weight:bold">225</span>)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">90</span> )
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">89</span> )

<span style="color:#fff;font-weight:bold">def</span> func6(a1, a2, a3):
  s.add(a1 &lt;= a2)
  s.add(a2 &lt;= a3)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">85</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">110</span>)
  s.add(a3 &gt; <span style="color:#ff0;font-weight:bold">115</span>)
  s.add(((a2 + a3) ^ (a1 + a2)) == <span style="color:#ff0;font-weight:bold">44</span>)
  s.add(URem(a2 + a3, a1) + a2 == <span style="color:#ff0;font-weight:bold">161</span> ) <span style="color:#007f7f"># Use the function URem() for unsigned remainder, and SRem() for signed remainder. https://z3prover.github.io/api/html/classz3py_1_1_bit_vec_ref.html</span>

<span style="color:#fff;font-weight:bold">def</span> func7(a1, a2, a3):
  s.add(a1 &gt;= a2)
  s.add(a2 &gt;= a3)
  s.add(a1 &lt;= <span style="color:#ff0;font-weight:bold">119</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">90</span>)
  s.add(a3 &lt;= <span style="color:#ff0;font-weight:bold">89</span>)
  s.add(((a1 + a3) ^ (a2 + a3)) == <span style="color:#ff0;font-weight:bold">122</span> )
  s.add(URem(a1 + a3,  a2) + a3 == <span style="color:#ff0;font-weight:bold">101</span>)

<span style="color:#fff;font-weight:bold">def</span> func8(a1, a2, a3):
  s.add(a1 &lt;= a2)
  s.add(a2 &lt;= a3)
  s.add( a3 &lt;= <span style="color:#ff0;font-weight:bold">114</span>)
  s.add( UDiv(a1 + a2, a3) * a2 == <span style="color:#ff0;font-weight:bold">97</span> ) <span style="color:#007f7f"># Use the function UDiv() for unsigned division. https://z3prover.github.io/api/html/classz3py_1_1_bit_vec_ref.html</span>
  s.add( a3 ^ (a1 - a2) == -<span style="color:#ff0;font-weight:bold">8</span>*<span style="color:#ff0;font-weight:bold">13</span>)

<span style="color:#fff;font-weight:bold">def</span> func9(a1, a2, a3):
  s.add(a1 == a2)
  s.add(a2 &gt;= a3)
  s.add(a3 &lt;= <span style="color:#ff0;font-weight:bold">99</span>)
  s.add(a3 + a1 * (a3 - a2) - a1 == -<span style="color:#ff0;font-weight:bold">1443</span>)

<span style="color:#fff;font-weight:bold">def</span> func10(a1, a2, a3):
  s.add(a1 &gt;= a2)
  s.add(a2 &gt;= a3)
  s.add(a2 * (a1 + a3 + <span style="color:#ff0;font-weight:bold">1</span>) - a3 == <span style="color:#ff0;font-weight:bold">15514</span>)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">90</span>)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">99</span>)

<span style="color:#fff;font-weight:bold">def</span> func11(a1, a2, a3):
  s.add(a2 &gt;= a1)
  s.add(a1 &gt;= a3)
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">100</span>)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">104</span>)
  s.add(a1 + (a2 ^ (a2 - a3)) - a3 == <span style="color:#ff0;font-weight:bold">70</span>)
  s.add(UDiv(a2 + a3, a1) + a1 == <span style="color:#ff0;font-weight:bold">68</span> )

<span style="color:#fff;font-weight:bold">def</span> func12(a1, a2, a3):
  s.add(a1 &gt;= a2)
  s.add(a2 &gt;= a3)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">59</span>)
  s.add(a3 &lt;= <span style="color:#ff0;font-weight:bold">44</span>)
  s.add(a1 + (a2 ^ (a3 + a2)) - a3 == <span style="color:#ff0;font-weight:bold">111</span>)
  s.add((a2 ^ (a2 - a3)) + a2 == <span style="color:#ff0;font-weight:bold">101</span> )

<span style="color:#fff;font-weight:bold">def</span> func13(a1, a2, a3):
  s.add(a1 &lt;= a2)
  s.add(a2 &lt;= a3)
  s.add(a1 &gt; <span style="color:#ff0;font-weight:bold">40</span> )
  s.add(a2 &gt; <span style="color:#ff0;font-weight:bold">90</span> )
  s.add(a3 &lt;= <span style="color:#ff0;font-weight:bold">109</span>)
  s.add(a3 + (a2 ^ (a3 + a1)) - a1 == <span style="color:#ff0;font-weight:bold">269</span>)
  s.add((a3 ^ (a2 - a1)) + a2 == <span style="color:#ff0;font-weight:bold">185</span>)

<span style="color:#fff;font-weight:bold">def</span> func14(a1, a2, a3):
  s.add(a1 &gt;= a3)
  s.add(a2 &gt;= a3)
  s.add(a2 &lt;= <span style="color:#ff0;font-weight:bold">99</span>)
  s.add(a3 &gt; <span style="color:#ff0;font-weight:bold">90</span>)
  s.add(a1 + (a2 ^ (a2 + a1)) - a3 == <span style="color:#ff0;font-weight:bold">185</span> )

<span style="color:#fff;font-weight:bold">def</span> func15(a1, a2, a3):
  s.add(a2 &gt;= a3)
  s.add(a2 &gt;= a1)
  s.add(a3 &gt; <span style="color:#ff0;font-weight:bold">95</span>)
  s.add( a2 &lt;= <span style="color:#ff0;font-weight:bold">109</span>)
  s.add(((a2 - a1) * a2 ^ a3) - a1 == <span style="color:#ff0;font-weight:bold">1214</span>)
  s.add(((a3 - a2) * a3 ^ a1) + a2 == -<span style="color:#ff0;font-weight:bold">1034</span>)

<span style="color:#fff;font-weight:bold">def</span> is_valid(x):
  <span style="color:#fff;font-weight:bold">return</span> Or(And(x &gt;= <span style="color:#ff0;font-weight:bold">65</span>, x &lt;= <span style="color:#ff0;font-weight:bold">90</span>), And(x &gt;= <span style="color:#ff0;font-weight:bold">97</span>, x &lt;= <span style="color:#ff0;font-weight:bold">122</span>), And(x &gt;= <span style="color:#ff0;font-weight:bold">48</span>, x &lt;= <span style="color:#ff0;font-weight:bold">57</span>), And(x == <span style="color:#ff0;font-weight:bold">95</span>), And(x == <span style="color:#ff0;font-weight:bold">33</span>), And(x == <span style="color:#ff0;font-weight:bold">64</span>), And(x == <span style="color:#ff0;font-weight:bold">35</span>), And(x == <span style="color:#ff0;font-weight:bold">36</span>), And(x == <span style="color:#ff0;font-weight:bold">37</span>), And(x == <span style="color:#ff0;font-weight:bold">94</span>), And(x == <span style="color:#ff0;font-weight:bold">38</span>), And(x == <span style="color:#ff0;font-weight:bold">42</span>), And(x == <span style="color:#ff0;font-weight:bold">63</span>), And(x == <span style="color:#ff0;font-weight:bold">58</span>), And(x == <span style="color:#ff0;font-weight:bold">40</span>), And(x == <span style="color:#ff0;font-weight:bold">41</span>))

s = Solver()

x = [ BitVec(<span style="color:#0ff;font-weight:bold">&#39;a</span><span style="color:#0ff;font-weight:bold">%i</span><span style="color:#0ff;font-weight:bold">&#39;</span> % i, <span style="color:#ff0;font-weight:bold">32</span>) <span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">26</span>) ]

<span style="color:#fff;font-weight:bold">for</span> i in <span style="color:#fff;font-weight:bold">range</span>(<span style="color:#ff0;font-weight:bold">26</span>):
  s.add(is_valid(x[i]))

func1(x[<span style="color:#ff0;font-weight:bold">0</span>], x[<span style="color:#ff0;font-weight:bold">1</span>])
func2(x[<span style="color:#ff0;font-weight:bold">1</span>], x[<span style="color:#ff0;font-weight:bold">2</span>])
func3(x[<span style="color:#ff0;font-weight:bold">2</span>], x[<span style="color:#ff0;font-weight:bold">3</span>])
func4(x[<span style="color:#ff0;font-weight:bold">3</span>], x[<span style="color:#ff0;font-weight:bold">4</span>])
func5(x[<span style="color:#ff0;font-weight:bold">4</span>], x[<span style="color:#ff0;font-weight:bold">5</span>])
func6(x[<span style="color:#ff0;font-weight:bold">5</span>], x[<span style="color:#ff0;font-weight:bold">6</span>], x[<span style="color:#ff0;font-weight:bold">7</span>])
func7(x[<span style="color:#ff0;font-weight:bold">7</span>], x[<span style="color:#ff0;font-weight:bold">8</span>], x[<span style="color:#ff0;font-weight:bold">9</span>])
func8(x[<span style="color:#ff0;font-weight:bold">9</span>], x[<span style="color:#ff0;font-weight:bold">10</span>], x[<span style="color:#ff0;font-weight:bold">11</span>])
func9(x[<span style="color:#ff0;font-weight:bold">11</span>], x[<span style="color:#ff0;font-weight:bold">12</span>], x[<span style="color:#ff0;font-weight:bold">13</span>])
func10(x[<span style="color:#ff0;font-weight:bold">13</span>], x[<span style="color:#ff0;font-weight:bold">14</span>], x[<span style="color:#ff0;font-weight:bold">15</span>])
func11(x[<span style="color:#ff0;font-weight:bold">15</span>], x[<span style="color:#ff0;font-weight:bold">16</span>], x[<span style="color:#ff0;font-weight:bold">17</span>])
func12(x[<span style="color:#ff0;font-weight:bold">17</span>], x[<span style="color:#ff0;font-weight:bold">18</span>], x[<span style="color:#ff0;font-weight:bold">19</span>])
func13(x[<span style="color:#ff0;font-weight:bold">19</span>], x[<span style="color:#ff0;font-weight:bold">20</span>], x[<span style="color:#ff0;font-weight:bold">21</span>])
func14(x[<span style="color:#ff0;font-weight:bold">21</span>], x[<span style="color:#ff0;font-weight:bold">22</span>], x[<span style="color:#ff0;font-weight:bold">23</span>])
func15(x[<span style="color:#ff0;font-weight:bold">23</span>], x[<span style="color:#ff0;font-weight:bold">24</span>], x[<span style="color:#ff0;font-weight:bold">25</span>])

<span style="color:#fff;font-weight:bold">while</span> s.check() == sat:
  solution = s.model()
  block = []
  <span style="color:#fff;font-weight:bold">for</span> d in solution:
    c = d()
    block.append(c != solution[d])
    flag = <span style="color:#0ff;font-weight:bold">&#34;&#34;</span>
    <span style="color:#fff;font-weight:bold">for</span> n in x:
      char = solution[n].as_long()
      flag += <span style="color:#fff;font-weight:bold">chr</span>(char)
    <span style="color:#fff;font-weight:bold">print</span> flag
  s.add(Or(block))
</code></pre></div><p>Our job was considerably easier than a real world situation because the binary was easy to reverse, since there was no other functionality in itself besides the flag validation functions. Anyway, Z3 is indeed a very good tool to keep around if you need to find what some binary is doing and you don&rsquo;t feel like spending too much time in front of a debugger.</p>
<h2 id="symbolic-execution">Symbolic Execution</h2>
<p>Symbolic execution is a program analysis technique which provides the ability to automatically enumerate the feasible paths of a program. This technique has received more and more attention, as mentioned before, due to the increased performance in computers but also due to improvements to the constraint solvers on which the technique relies.</p>
<p>Instead of a program run with concrete input, symbolic execution runs the program with symbolic input. Each input will then be represented by a placeholder for an initially non contrained value. As the program runs, symbolic execution will keep track on how the variables depend on the symbolic input.</p>
<p>When a branch that depends on symbolic input, for example an if statement, is found <em>a constraint solver is used to check which branches are feasible</em>. So, this means that actually we can use, for example KLEE, to solve our linear equation and Zebra puzzle. This might not be a smart use of KLEE but will allow us to play a bit with it.</p>
<p>The symbolic execution process is well described by Daniel Liew in his recent <a href="https://danliew.co.uk/assets/pdf/Liew-D-2018-PhD-Thesis.pdf">published thesis</a> on &ldquo;Symbolic execution of verification languages and floating-point code&rdquo;.</p>
<p><em>Instead of running the program on concrete input, where a particular input component might e.g. take the value 3, symbolic execution runs the program on symbolic input, where each input component is represented by a placeholder for an initially unconstrained value. As the program runs, symbolic execution keeps track of how program variables depend on the symbolic input. When a branch point (e.g. an if statement) dependent on symbolic input is encountered a constraint solver is used to check which branches are feasible. Each feasible path is then executed, making a copy (known as forking) of the current program state if necessary. On each feasible path (at least one must be feasible) the constraint that the branch imposed on the symbolic input is added to a per path set called the path condition (PC). The PC records all the symbolic branch conditions (branches that depend on symbolic input) that were traversed by the path. The PC has two purposes. First, it is used to check feasibility when encountering later branch points on that path. Second, the constraints in the PC can be solved and a satisfying assignment to the symbolic input can be found. This satisfying assignment can be used to replay execution of the program along the same path that (assuming that the program is deterministic) was symbolically executed and is effectively a test case. These automatically generated test cases can be useful to developers because they can be added to an existing test suite to increase code coverage or be used replay bugs.</em></p>
<p>In my simplistic words, Symbolic Execution, in short, is a program analysis technique that treats input data as symbolic variables (rather than concrete values). Or, quoting <a href="http://moflow.org/Presentations/Taint%20Nobody%20Got%20Time%20for%20Crash%20Analysis%20-%20slides.pdf">Richard @richinseattle Johnson</a>, <em>Symbolic execution lets us &ldquo;execute&rdquo; a series of instructions without using concrete values for variables. Instead of a numeric output, we get a formula for the output in terms of input variables that represents a potential range of values.</em></p>
<p>Or, as pointed by <a href="https://doar-e.github.io/presentations/securityday2015/SecDay-Lille-2015-Axel-0vercl0k-Souchet.html#/5/1">Axel Souchet</a>.</p>
<ul>
<li>Symbolic execution would be f(x) = x**2 + 10</li>
<li>Concrete execution would be f(3) = 19</li>
</ul>
<p>So, symbolic execution creates constraints based on symbolic variables. If used in conjunction with a constraint solver (like Z3) to generate new inputs/test cases, we have Concolic Execution.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">Symbolic Execution + Constraint Solving = Concolic Execution
</code></pre></div><p>Concolic execution is used to aid <a href="https://en.wikipedia.org/wiki/Fuzzing">Fuzzing</a> and software verification with the goal of maximizing code coverage.</p>
<p>If we look at a simple function, like the one below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#fff;font-weight:bold">int</span> foobar(<span style="color:#fff;font-weight:bold">int</span> n)
{
  <span style="color:#fff;font-weight:bold">int</span> i = n * <span style="color:#ff0;font-weight:bold">5</span>;

  <span style="color:#fff;font-weight:bold">if</span>(i == <span style="color:#ff0;font-weight:bold">25</span>)
    bug();

  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
}
</code></pre></div><p>By using &ldquo;dumb&rdquo; fuzzing what are our real changes of hitting the bug? Yes, <code>1 in 2^32</code> (4 billion attempts). Read this <a href="http://moyix.blogspot.co.uk/2016/07/fuzzing-with-afl-is-an-art.html">post</a> for an interesting case of <a href="http://lcamtuf.coredump.cx/afl/">AFL</a> dealing with something slightly complex than the one above.</p>
<p>I recommend you to look at another presentation from <a href="http://www.nosuchcon.org/talks/2014/D2_06_Richard_Johnson_Sagely_Advice.pdf">Richard @richinseattle Johnson</a> to get good foundations on this subject. You can watch the video <a href="https://www.youtube.com/watch?v=Xt5A2jEgDVU">here</a>.</p>
<p>Anyway, this post it&rsquo;s not about fuzzing. So let&rsquo;s move on and solve our linear equation again, this time with <a href="https://klee.github.io/">KLEE</a>.</p>
<h2 id="klee">KLEE</h2>
<p><a href="https://klee.github.io/">KLEE</a> can be a bit though to install, so just use the <a href="http://klee.github.io/docker/">Klee&rsquo;s Docker image</a>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker pull klee/klee
$ docker run -ti --name=my_klee_container --ulimit=<span style="color:#0ff;font-weight:bold">&#39;stack=-1:-1&#39;</span> klee/klee
klee@02ca010455db:~$
</code></pre></div><h3 id="linear-equation-with-3-variables-1">Linear equation with 3 variables</h3>
<p>We&rsquo;ll use the same linear equation system with 3 variables as before, that I grabbed from <a href="http://tutorial.math.lamar.edu/Classes/Alg/SystemsThreeVrble.aspx">here</a>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">x - 2y + 3z = 7
2x + y + z = 4
-3x + 2y - 2z = -10
</code></pre></div><p>To solve it with KLEE I simply created the following logic in a file called <code>equation.c</code>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;assert.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;./klee_src/include/klee/klee.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">int</span> main(<span style="color:#fff;font-weight:bold">int</span> argc, <span style="color:#fff;font-weight:bold">char</span>* argv[]) 
{
  <span style="color:#fff;font-weight:bold">int</span> x, y, z;

  klee_make_symbolic(&amp;x, <span style="color:#fff;font-weight:bold">sizeof</span> x, <span style="color:#0ff;font-weight:bold">&#34;x&#34;</span>); 
  klee_make_symbolic(&amp;y, <span style="color:#fff;font-weight:bold">sizeof</span> y, <span style="color:#0ff;font-weight:bold">&#34;y&#34;</span>); 
  klee_make_symbolic(&amp;z, <span style="color:#fff;font-weight:bold">sizeof</span> z, <span style="color:#0ff;font-weight:bold">&#34;z&#34;</span>);

  <span style="color:#fff;font-weight:bold">if</span> (x - <span style="color:#ff0;font-weight:bold">2</span> * y + <span style="color:#ff0;font-weight:bold">3</span> * z != <span style="color:#ff0;font-weight:bold">7</span>) <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
  <span style="color:#fff;font-weight:bold">if</span> (<span style="color:#ff0;font-weight:bold">2</span> * x + y + z != <span style="color:#ff0;font-weight:bold">4</span>) <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
  <span style="color:#fff;font-weight:bold">if</span> (-<span style="color:#ff0;font-weight:bold">3</span> * x + <span style="color:#ff0;font-weight:bold">2</span> * y - <span style="color:#ff0;font-weight:bold">2</span> * z != -<span style="color:#ff0;font-weight:bold">10</span>) <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;

  klee_assert(<span style="color:#ff0;font-weight:bold">0</span>);
}
</code></pre></div><p>And ran it through KLEE as below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clang -emit-llvm -g -c equation.c
$ klee equation.bc
KLEE: output directory is <span style="color:#0ff;font-weight:bold">&#34;/home/klee/klee-out-2&#34;</span>
KLEE: Using STP solver backend
KLEE: ERROR: /home/klee/equation.c:16: ASSERTION FAIL: <span style="color:#ff0;font-weight:bold">0</span>
KLEE: NOTE: now ignoring this error at this location

KLEE: <span style="color:#fff;font-weight:bold">done</span>: total instructions = <span style="color:#ff0;font-weight:bold">55</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: completed paths = <span style="color:#ff0;font-weight:bold">4</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: generated tests = <span style="color:#ff0;font-weight:bold">4</span>
$ ls klee-last | grep err
test000003.assert.err
$ ktest-tool --write-ints klee-last/test000003.ktest
ktest file : <span style="color:#0ff;font-weight:bold">&#39;klee-last/test000003.ktest&#39;</span>
args       : [<span style="color:#0ff;font-weight:bold">&#39;equation.bc&#39;</span>]
num objects: <span style="color:#ff0;font-weight:bold">3</span>
object    0: name: b<span style="color:#0ff;font-weight:bold">&#39;x&#39;</span>
object    0: size: <span style="color:#ff0;font-weight:bold">4</span>
object    0: data: <span style="color:#ff0;font-weight:bold">2</span>
object    1: name: b<span style="color:#0ff;font-weight:bold">&#39;y&#39;</span>
object    1: size: <span style="color:#ff0;font-weight:bold">4</span>
object    1: data: -1
object    2: name: b<span style="color:#0ff;font-weight:bold">&#39;z&#39;</span>
object    2: size: <span style="color:#ff0;font-weight:bold">4</span>
object    2: data: <span style="color:#ff0;font-weight:bold">1</span>
</code></pre></div><p>This is indeed the solution to the equation system <code>(x = 2, y = -1, z = 1)</code>.</p>
<p>This can be slightly optimized if we use <code>klee_assume()</code>, which tells KLEE to cut path if some constraint is not satisfied. So our equation could be written as below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;assert.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;./klee_src/include/klee/klee.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">int</span> main(<span style="color:#fff;font-weight:bold">int</span> argc, <span style="color:#fff;font-weight:bold">char</span>* argv[]) 
{
  <span style="color:#fff;font-weight:bold">int</span> x, y, z;

  klee_make_symbolic(&amp;x, <span style="color:#fff;font-weight:bold">sizeof</span> x, <span style="color:#0ff;font-weight:bold">&#34;x&#34;</span>); 
  klee_make_symbolic(&amp;y, <span style="color:#fff;font-weight:bold">sizeof</span> y, <span style="color:#0ff;font-weight:bold">&#34;y&#34;</span>); 
  klee_make_symbolic(&amp;z, <span style="color:#fff;font-weight:bold">sizeof</span> z, <span style="color:#0ff;font-weight:bold">&#34;z&#34;</span>);

  klee_assume(x - <span style="color:#ff0;font-weight:bold">2</span> * y + <span style="color:#ff0;font-weight:bold">3</span> * z == <span style="color:#ff0;font-weight:bold">7</span>);
  klee_assume(<span style="color:#ff0;font-weight:bold">2</span> * x + y + z == <span style="color:#ff0;font-weight:bold">4</span>);
  klee_assume(-<span style="color:#ff0;font-weight:bold">3</span> * x + <span style="color:#ff0;font-weight:bold">2</span> * y - <span style="color:#ff0;font-weight:bold">2</span> * z == -<span style="color:#ff0;font-weight:bold">10</span>);

  klee_assert(<span style="color:#ff0;font-weight:bold">0</span>);
}
</code></pre></div><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clang -emit-llvm -g -c equation2.c 
$ klee equation2.bc
KLEE: output directory is <span style="color:#0ff;font-weight:bold">&#34;/home/klee/klee-out-3&#34;</span>
KLEE: Using STP solver backend
KLEE: ERROR: /home/klee/equation2.c:16: ASSERTION FAIL: <span style="color:#ff0;font-weight:bold">0</span>
KLEE: NOTE: now ignoring this error at this location

KLEE: <span style="color:#fff;font-weight:bold">done</span>: total instructions = <span style="color:#ff0;font-weight:bold">49</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: completed paths = <span style="color:#ff0;font-weight:bold">1</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: generated tests = <span style="color:#ff0;font-weight:bold">1</span>
$ ls klee-last | grep err
test000001.assert.err
$ ktest-tool --write-ints klee-last/test000001.ktest
ktest file : <span style="color:#0ff;font-weight:bold">&#39;klee-last/test000001.ktest&#39;</span>
args       : [<span style="color:#0ff;font-weight:bold">&#39;equation2.bc&#39;</span>]
num objects: <span style="color:#ff0;font-weight:bold">3</span>
object    0: name: b<span style="color:#0ff;font-weight:bold">&#39;x&#39;</span>
object    0: size: <span style="color:#ff0;font-weight:bold">4</span>
object    0: data: <span style="color:#ff0;font-weight:bold">2</span>
object    1: name: b<span style="color:#0ff;font-weight:bold">&#39;y&#39;</span>
object    1: size: <span style="color:#ff0;font-weight:bold">4</span>
object    1: data: -1
object    2: name: b<span style="color:#0ff;font-weight:bold">&#39;z&#39;</span>
object    2: size: <span style="color:#ff0;font-weight:bold">4</span>
object    2: data: <span style="color:#ff0;font-weight:bold">1</span>
</code></pre></div><p>I&rsquo;m not going to solve the Zebra puzzle with KLEE, since we won&rsquo;t really learn anything new compared to what we have seen until now. You can try it yourself, or if you want just look at Yurichev&rsquo;s solution <a href="https://yurichev.com/writings/SAT_SMT_draft-EN.pdf">here</a> (page 107 at the time of this writing).</p>
<h3 id="ctf-challenge-get-the-flag-1">CTF Challenge (get the flag)</h3>
<p>Instead, we&rsquo;ll see how to solve the RedVelvet CTF challenge again, this time with KLEE. In order to use KLEE you need access to the source code. In this case, since we don&rsquo;t have access to the source code of the RedVelvet CTF challenge we&rsquo;ll use IDA Pro Hex-Rays decompiler (we already saw how to do that) to get the code. Yes, we&rsquo;ll need to fix the code, so we can compile it. Unfortunately <a href="https://github.com/avast-tl/retdec">RetDec</a> doesn&rsquo;t support 64bits so yes, we&rsquo;ll have to stick with IDA.</p>
<p>Below are the main steps we need to complete in order to solve the challenge with KLEE.</p>
<ul>
<li>Decompile the RedVelvet binary to source code with IDA Pro Hex-Rays decompiler</li>
<li>Include defs.h from the plugins folder of IDA Pro in our source file</li>
<li>Replace the user input with <code>klee_make_symbolic(input, sizeof(input), &quot;input&quot;);</code></li>
<li>Replace the flag printf with <code>klee_assert(0);</code></li>
</ul>
<p>The code we get from IDA Pro Hex-Rays decompiler won&rsquo;t compile, I&rsquo;ll skip the step of fixing the code and I&rsquo;ll just give you the code ready to compile below. If you are curious, you can compare the changes yourself.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;stdlib.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;string.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;openssl/sha.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;defs.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">int</span>  func1(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 * <span style="color:#ff0;font-weight:bold">2</span> * (<span style="color:#fff;font-weight:bold">char</span>)(a2 ^ a1) - a2 != <span style="color:#ff0;font-weight:bold">10858</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt;= <span style="color:#ff0;font-weight:bold">85</span> || a1 &gt; <span style="color:#ff0;font-weight:bold">95</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">96</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">111</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func2(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 % a2 != <span style="color:#ff0;font-weight:bold">7</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt;= <span style="color:#ff0;font-weight:bold">90</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func3(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 / a2 + (<span style="color:#fff;font-weight:bold">char</span>)(a2 ^ a1) != <span style="color:#ff0;font-weight:bold">21</span> || a1 &gt; <span style="color:#ff0;font-weight:bold">99</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">119</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func4(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">signed</span> <span style="color:#fff;font-weight:bold">__int64</span> v2; <span style="color:#007f7f">// rtt@1
</span><span style="color:#007f7f"></span>
  LODWORD(v2) = (<span style="color:#fff;font-weight:bold">char</span>)(a2 ^ a1 ^ a2);
  HIDWORD(v2) = (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">__int64</span>)(<span style="color:#fff;font-weight:bold">char</span>)(a2 ^ a1 ^ a2) &gt;&gt; <span style="color:#ff0;font-weight:bold">32</span>;
  <span style="color:#fff;font-weight:bold">if</span> ( (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)(v2 % a2) + a1 != <span style="color:#ff0;font-weight:bold">137</span> || a1 &lt;= <span style="color:#ff0;font-weight:bold">115</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">99</span> || a2 != <span style="color:#ff0;font-weight:bold">95</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func5(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">if</span> ( ((a2 + a1) ^ (<span style="color:#fff;font-weight:bold">char</span>)(a1 ^ a2 ^ a1)) != <span style="color:#ff0;font-weight:bold">225</span> || a1 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">89</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func6(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &gt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt;= <span style="color:#ff0;font-weight:bold">85</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">110</span> || a3 &lt;= <span style="color:#ff0;font-weight:bold">115</span> || ((a2 + a3) ^ (a1 + a2)) != <span style="color:#ff0;font-weight:bold">44</span> || (a2 + a3) % a1 + a2 != <span style="color:#ff0;font-weight:bold">161</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func7(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &gt; <span style="color:#ff0;font-weight:bold">119</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a3 &gt; <span style="color:#ff0;font-weight:bold">89</span> || ((a1 + a3) ^ (a2 + a3)) != <span style="color:#ff0;font-weight:bold">122</span> || (a1 + a3) % a2 + a3 != <span style="color:#ff0;font-weight:bold">101</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func8(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &gt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a3 &gt; <span style="color:#ff0;font-weight:bold">114</span> || (a1 + a2) / a3 * a2 != <span style="color:#ff0;font-weight:bold">97</span> || (a3 ^ (a1 - a2)) * a2 != -<span style="color:#ff0;font-weight:bold">10088</span> || a3 &gt; <span style="color:#ff0;font-weight:bold">114</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func9(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 != a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a3 &gt; <span style="color:#ff0;font-weight:bold">99</span> || a3 + a1 * (a3 - a2) - a1 != -<span style="color:#ff0;font-weight:bold">1443</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func10(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 * (a1 + a3 + <span style="color:#ff0;font-weight:bold">1</span>) - a3 != <span style="color:#ff0;font-weight:bold">15514</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">99</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func11(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a1 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt;= <span style="color:#ff0;font-weight:bold">100</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">104</span> || a1 + (a2 ^ (a2 - a3)) - a3 != <span style="color:#ff0;font-weight:bold">70</span> || (a2 + a3) / a1 + a1 != <span style="color:#ff0;font-weight:bold">68</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func12(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; <span style="color:#ff0;font-weight:bold">59</span> || a3 &gt; <span style="color:#ff0;font-weight:bold">44</span> || a1 + (a2 ^ (a3 + a2)) - a3 != <span style="color:#ff0;font-weight:bold">111</span> || (a2 ^ (a2 - a3)) + a2 != <span style="color:#ff0;font-weight:bold">101</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func13(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &gt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt;= <span style="color:#ff0;font-weight:bold">40</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a3 &gt; <span style="color:#ff0;font-weight:bold">109</span> || a3 + (a2 ^ (a3 + a1)) - a1 != <span style="color:#ff0;font-weight:bold">269</span> || (a3 ^ (a2 - a1)) + a2 != <span style="color:#ff0;font-weight:bold">185</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func14(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; <span style="color:#ff0;font-weight:bold">99</span> || a3 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a1 + (a2 ^ (a2 + a1)) - a3 != <span style="color:#ff0;font-weight:bold">185</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func15(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a1 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a3 &lt;= <span style="color:#ff0;font-weight:bold">95</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">109</span> || ((a2 - a1) * a2 ^ a3) - a1 != <span style="color:#ff0;font-weight:bold">1214</span> || ((a3 - a2) * a3 ^ a1) + a2 != -<span style="color:#ff0;font-weight:bold">1034</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span> main(<span style="color:#fff;font-weight:bold">int</span> argc, <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> **argv, <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> **envp)
{
  <span style="color:#fff;font-weight:bold">char</span> buf[<span style="color:#ff0;font-weight:bold">27</span>];
  size_t v6; <span style="color:#007f7f">// rax@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">signed</span> <span style="color:#fff;font-weight:bold">int</span> i; <span style="color:#007f7f">// [sp+8h] [bp-1B8h]@2
</span><span style="color:#007f7f"></span>  SHA256_CTX v11; <span style="color:#007f7f">// [sp+50h] [bp-170h]@2
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">char</span> v38[<span style="color:#ff0;font-weight:bold">32</span>]; <span style="color:#007f7f">// [sp+E0h] [bp-E0h]@2
</span><span style="color:#007f7f"></span>
  <span style="color:#fff;font-weight:bold">char</span> s1[<span style="color:#ff0;font-weight:bold">80</span>]; <span style="color:#007f7f">// [sp+100h] [bp-C0h]@3
</span><span style="color:#007f7f"></span>  <span style="color:#fff;font-weight:bold">char</span> s2[<span style="color:#ff0;font-weight:bold">8</span>]; <span style="color:#007f7f">// [sp+150h] [bp-70h]@1
</span><span style="color:#007f7f"></span>  *(_QWORD *)s2 = <span style="color:#ff0;font-weight:bold">3905859155515433264LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v41[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v41 = <span style="color:#ff0;font-weight:bold">3990529441497888818LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v42[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v42 = <span style="color:#ff0;font-weight:bold">7017565014431380534LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v43[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v43 = <span style="color:#ff0;font-weight:bold">3977633058323522358LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v44[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v44 = <span style="color:#ff0;font-weight:bold">7364290724313116725LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v45[<span style="color:#ff0;font-weight:bold">8</span>];
   *(_QWORD *)v45 = <span style="color:#ff0;font-weight:bold">3991705742141175652LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v46[<span style="color:#ff0;font-weight:bold">8</span>];
   *(_QWORD *)v46 = <span style="color:#ff0;font-weight:bold">7363494672811320633LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v47[<span style="color:#ff0;font-weight:bold">8</span>];
   *(_QWORD *)v47 = <span style="color:#ff0;font-weight:bold">3847534474596595814LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v48[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v48 = <span style="color:#ff0;font-weight:bold">0LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v49[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v49 = <span style="color:#ff0;font-weight:bold">0LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v50[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v50 = <span style="color:#ff0;font-weight:bold">0LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v51[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v51 = <span style="color:#ff0;font-weight:bold">0LL</span>;
  <span style="color:#fff;font-weight:bold">char</span> v52[<span style="color:#ff0;font-weight:bold">8</span>];
  *(_QWORD *)v52 = <span style="color:#ff0;font-weight:bold">0</span>;

  printf(<span style="color:#0ff;font-weight:bold">&#34;Your flag : &#34;</span>);
  fgets(buf, <span style="color:#ff0;font-weight:bold">27</span>, stdin);
  func1((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">0</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">1</span>]);
  func2((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">1</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">2</span>]);
  func3((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">2</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">3</span>]);
  func4((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">3</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">4</span>]);
  func5((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">4</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">5</span>]);
  func6((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">5</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">6</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">7</span>]);
  func7((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">7</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">8</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">9</span>]);
  func8((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">9</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">10</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">11</span>]);
  func9((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">11</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">12</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">13</span>]);
  func10((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">13</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">14</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">15</span>]);
  func11((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">15</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">16</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">17</span>]);
  func12((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">17</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">18</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">19</span>]);
  func13((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">19</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">20</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">21</span>]);
  func14((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">21</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">22</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">23</span>]);
  func15((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">23</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">24</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">25</span>]);
  SHA256_Init(&amp;v11);
  v6 = strlen(buf);
  SHA256_Update(&amp;v11, buf, v6);
  SHA256_Final(v38, &amp;v11);
  <span style="color:#fff;font-weight:bold">for</span> ( i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt;= <span style="color:#ff0;font-weight:bold">31</span>; ++i )
    sprintf(&amp;s1[<span style="color:#ff0;font-weight:bold">2</span> * i], <span style="color:#0ff;font-weight:bold">&#34;%02x&#34;</span>, (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">__int8</span>)v38[i]);
  <span style="color:#fff;font-weight:bold">if</span> ( strcmp(s1, s2) )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  printf(<span style="color:#0ff;font-weight:bold">&#34;flag : {</span><span style="color:#0ff;font-weight:bold">\&#34;</span><span style="color:#0ff;font-weight:bold"> %s </span><span style="color:#0ff;font-weight:bold">\&#34;</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>, buf);
  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
}
</code></pre></div><p>After our fixes, we compile it, and we run it to make sure it mimics exactly the original binary.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ gcc -o red_velvet red_velvet.c -lssl -lcrypto
$ ./red_velvet
Your flag : lalala
</code></pre></div><p>Well, it runs so it must be ok. Let&rsquo;s proceed with our changes. Connect to the KLEE docker container.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker ps -a
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                    PORTS               NAMES
98643f6c5c8a        klee/klee           <span style="color:#0ff;font-weight:bold">&#34;/bin/bash&#34;</span>         <span style="color:#ff0;font-weight:bold">24</span> hours ago        Exited (0) <span style="color:#ff0;font-weight:bold">22</span> hours ago                       my_first_klee_container
$ docker start -ai 98643f6c5c8a
$ 
</code></pre></div><p>Now, we need to change, again, our <code>red_velvet.c</code> with the required KLEE modifications. Below is a unified diff showing the changes I made.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#f00">$</span> diff -uN re-built/red_velvet.c red_velvet.klee.c
--- re-built/red_velvet.c       <span style="color:#ff0;font-weight:bold">2018</span>-<span style="color:#ff0;font-weight:bold">05</span>-<span style="color:#ff0;font-weight:bold">19</span> <span style="color:#ff0;font-weight:bold">13</span>:<span style="color:#ff0;font-weight:bold">36</span>:<span style="color:#ff0;font-weight:bold">49.593046595</span> +<span style="color:#ff0;font-weight:bold">0100</span>
+++ red_velvet.klee.c   <span style="color:#ff0;font-weight:bold">2018</span>-<span style="color:#ff0;font-weight:bold">05</span>-<span style="color:#ff0;font-weight:bold">19</span> <span style="color:#ff0;font-weight:bold">13</span>:<span style="color:#ff0;font-weight:bold">38</span>:<span style="color:#ff0;font-weight:bold">51.945568668</span> +<span style="color:#ff0;font-weight:bold">0100</span>
<span style="color:#f00">@@</span> -<span style="color:#ff0;font-weight:bold">3</span>,<span style="color:#ff0;font-weight:bold">6</span> +<span style="color:#ff0;font-weight:bold">3</span>,<span style="color:#ff0;font-weight:bold">8</span> <span style="color:#f00">@@</span>
 <span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;string.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span> <span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;openssl/sha.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span> <span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;defs.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>+<span style="color:#f00">#</span>include &lt;assert.h&gt;
+<span style="color:#f00">#</span>include <span style="color:#0ff;font-weight:bold">&#34;./klee_src/include/klee/klee.h&#34;</span>

 <span style="color:#fff;font-weight:bold">int</span>  func1(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
 {
<span style="color:#f00">@@</span> -<span style="color:#ff0;font-weight:bold">193</span>,<span style="color:#ff0;font-weight:bold">8</span> +<span style="color:#ff0;font-weight:bold">195</span>,<span style="color:#ff0;font-weight:bold">12</span> <span style="color:#f00">@@</span>
   <span style="color:#fff;font-weight:bold">char</span> v52[<span style="color:#ff0;font-weight:bold">8</span>];
   *(_QWORD *)v52 = <span style="color:#ff0;font-weight:bold">0</span>;

+<span style="color:#f00">#</span>ifdef KLEE
+  klee_make_symbolic(buf, <span style="color:#fff;font-weight:bold">sizeof</span>(buf), <span style="color:#0ff;font-weight:bold">&#34;buf&#34;</span>);
+<span style="color:#f00">#</span><span style="color:#fff;font-weight:bold">else</span>
   printf(<span style="color:#0ff;font-weight:bold">&#34;Your flag : &#34;</span>);
   fgets(buf, <span style="color:#ff0;font-weight:bold">27</span>, stdin);
+<span style="color:#f00">#</span>endif
   func1((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">0</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">1</span>]);
   func2((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">1</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">2</span>]);
   func3((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">2</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">3</span>]);
<span style="color:#f00">@@</span> -<span style="color:#ff0;font-weight:bold">218</span>,<span style="color:#ff0;font-weight:bold">6</span> +<span style="color:#ff0;font-weight:bold">224</span>,<span style="color:#ff0;font-weight:bold">10</span> <span style="color:#f00">@@</span>
     sprintf(&amp;s1[<span style="color:#ff0;font-weight:bold">2</span> * i], <span style="color:#0ff;font-weight:bold">&#34;%02x&#34;</span>, (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">__int8</span>)v38[i]);
   <span style="color:#fff;font-weight:bold">if</span> ( strcmp(s1, s2) )
     exit(<span style="color:#ff0;font-weight:bold">1</span>);
+<span style="color:#f00">#</span>ifdef KLEE
+  klee_assert(<span style="color:#ff0;font-weight:bold">0</span>);
+<span style="color:#f00">#</span><span style="color:#fff;font-weight:bold">else</span>
   printf(<span style="color:#0ff;font-weight:bold">&#34;flag : {</span><span style="color:#0ff;font-weight:bold">\&#34;</span><span style="color:#0ff;font-weight:bold"> %s </span><span style="color:#0ff;font-weight:bold">\&#34;</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>, buf);
+<span style="color:#f00">#</span>endif
   <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
 }
</code></pre></div><p>I added my changes inside a <code>#ifdef KLEE</code> to make things clear. As we can see, the changes are pretty straight forward. Note that in order to build our example we need to install <code>libssl-dev</code> first. The password for the KLEE docker container is <code>klee</code>.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo apt-get install libssl-dev
</code></pre></div><p>Once we have it installed, we can proceed. Don&rsquo;t forget to copy the <code>defs.h</code> file from IDA Pro.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clang -emit-llvm -g -c red_velvet.c -I/usr/include -lssl -lcrypto -DKLEE
clang: warning: -lssl: <span style="color:#0ff;font-weight:bold">&#39;linker&#39;</span> input unused
clang: warning: -lcrypto: <span style="color:#0ff;font-weight:bold">&#39;linker&#39;</span> input unused
</code></pre></div><p>This is a problem. It&rsquo;s only possible to compile when emitting <code>LLVM IR</code>, not link. This means our <code>openssl</code> functions &ldquo;won&rsquo;t work&rdquo; and we&rsquo;ll miss the checksum validation. Since the code uses some standard C/C++ functions, we need to add <code>--libc=uclibc</code> switch, so KLEE will use its own implementation.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clang -emit-llvm -g -c red_velvet.c -I/usr/include
$ klee --libc=uclibc --posix-runtime red_velvet.bc
KLEE: NOTE: Using klee-uclibc : /home/klee/klee_build/klee/Release+Debug+Asserts/lib/klee-uclibc.bca
KLEE: NOTE: Using model: /home/klee/klee_build/klee/Release+Debug+Asserts/lib/libkleeRuntimePOSIX.bca
KLEE: output directory is <span style="color:#0ff;font-weight:bold">&#34;/home/klee/klee-out-0&#34;</span>
KLEE: Using STP solver backend
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Final
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Init
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Update
KLEE: WARNING ONCE: calling external: syscall(16, 0, 21505, 62031344) at /home/klee/klee_src/runtime/POSIX/fd.c:980
KLEE: WARNING ONCE: Alignment of memory from call <span style="color:#0ff;font-weight:bold">&#34;malloc&#34;</span> is not modelled. Using alignment of 8.
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:22: divide by zero
KLEE: NOTE: now ignoring this error at this location
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:31: divide by zero
KLEE: NOTE: now ignoring this error at this location
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:42: divide by zero
KLEE: NOTE: now ignoring this error at this location
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
KLEE: WARNING ONCE: calling external: SHA256_Init(66061536) at /home/klee/red_velvet.c:224
KLEE: ERROR: /home/klee/red_velvet.c:223: failed external call: SHA256_Init
KLEE: NOTE: now ignoring this error at this location

KLEE: <span style="color:#fff;font-weight:bold">done</span>: total instructions = <span style="color:#ff0;font-weight:bold">13518</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: completed paths = <span style="color:#ff0;font-weight:bold">67</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: generated tests = <span style="color:#ff0;font-weight:bold">67</span>
$ ls klee-last | grep err
test000003.div.err
test000006.div.err
test000008.div.err
test000067.external.err
$ ktest-tool --write-ints klee-last/test000067.ktest 
ktest file : <span style="color:#0ff;font-weight:bold">&#39;klee-last/test000067.ktest&#39;</span>
args       : [<span style="color:#0ff;font-weight:bold">&#39;red_velvet.bc&#39;</span>]
num objects: <span style="color:#ff0;font-weight:bold">2</span>
object    0: name: b<span style="color:#0ff;font-weight:bold">&#39;model_version&#39;</span>
object    0: size: <span style="color:#ff0;font-weight:bold">4</span>
object    0: data: <span style="color:#ff0;font-weight:bold">1</span>
object    1: name: b<span style="color:#0ff;font-weight:bold">&#39;buf&#39;</span>
object    1: size: <span style="color:#ff0;font-weight:bold">27</span>
object    1: data: b<span style="color:#0ff;font-weight:bold">&#39;What_You_Wanna_Be?:)_lb_la\x00&#39;</span>
</code></pre></div><p>We know the solution above is valid. However, as you can see above there are 3 warnings.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">KLEE: WARNING: undefined reference to function: SHA256_Final
KLEE: WARNING: undefined reference to function: SHA256_Init
KLEE: WARNING: undefined reference to function: SHA256_Update
</code></pre></div><p>And an error.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">KLEE: ERROR: /home/klee/red_velvet.c:223: failed external call: SHA256_Init
</code></pre></div><p>And they shouldn&rsquo;t be ignored. If one of these functions get&rsquo;s called the program will terminate, as it happened. KLEE has several limitations, including floating point numbers, assembly code, threads, memory objects of variable size, sockets, and any external function should also be compiled and linked. The <code>openssl</code> external function calls limitation affect us.</p>
<p>What can we do? One option is to move those 3 functions from <code>openssl</code> into our <code>red_velvet.c</code>. I actually <a href="https://github.com/houseofxyz/symbolic-execution/blob/master/CTF-RedVelvet/red_velvet.openssl.c">did it</a>. However, if you look at the code you&rsquo;ll see inlined assembly. Which means, it won&rsquo;t work either (but at least you can see KLEE complaining about it as a reward). Another option is to build <code>openssl</code> into <code>LLVM IR</code> and then launch KLEE with the option <code>-link-llvm-lib=&lt;library file&gt;</code>. I&rsquo;m aware of some other possible options. First two, use <a href="http://llvm.org/docs/GoldPlugin.html">Gold linker with the LLVM plugin</a> or <a href="https://github.com/travitch/whole-program-llvm">Whole Program LLVM</a> plus <code>llvm-link</code>.</p>
<p>I didn&rsquo;t try any of those options though. Why? Well, if we think about it the way symbolic execution engines work, and the constraint solvers they use can&rsquo;t accurately generate and solve the constraints that describe the complete process of a checksum algorithm. However, a constraint solver can produce inputs that will pass a difficult check such as a password, a magic number, or even a checksum.</p>
<p>In our example, the checksum is at the end of our code, so by that time KLEE should have already found a &ldquo;solution&rdquo; that should pass the checksum. Right? Well, no. We actually already know that this challenge has more than one possible solution. That is, more than one input that satisfies all the constraints (except the checksum itself). So these inputs won&rsquo;t pass the program&rsquo;s first validation (checksum) unless we are really lucky.</p>
<p>Anyway, didn&rsquo;t I say that as soon as one of those 3 <code>openssl</code> functions are called the program will terminate? Yes, but you can use a KLEE option to make it call the external function despite the warnings we saw before. The option is <code>-load</code>. See below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clang -emit-llvm -g -c red_velvet.c -DKLEE
$ klee --optimize -load=/usr/lib/x86_64-linux-gnu/libssl.so -load=/usr/lib/x86_64-linux-gnu/libcrypto.so --libc=uclibc --posix-runtime -allow-external-sym-calls -emit-all-errors red_velvet.bc
KLEE: NOTE: Using klee-uclibc : /home/klee/klee_build/klee/Release+Debug+Asserts/lib/klee-uclibc.bca
KLEE: NOTE: Using model: /home/klee/klee_build/klee/Release+Debug+Asserts/lib/libkleeRuntimePOSIX.bca
KLEE: output directory is <span style="color:#0ff;font-weight:bold">&#34;/home/klee/klee-out-16&#34;</span>
KLEE: Using STP solver backend
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Final
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Init
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Update
KLEE: WARNING ONCE: calling external: syscall(16, 0, 21505, 43118368) at /home/klee/klee_src/runtime/POSIX/fd.c:980
KLEE: WARNING ONCE: Alignment of memory from call <span style="color:#0ff;font-weight:bold">&#34;malloc&#34;</span> is not modelled. Using alignment of 8.
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:21: divide by zero
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:30: divide by zero
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:41: divide by zero
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
KLEE: WARNING ONCE: calling external: SHA256_Init(59051440) at /home/klee/klee_build/klee-uclibc/libc/string/strlen.c:22
KLEE: ERROR: /home/klee/klee_build/klee-uclibc/libc/string/strlen.c:22: memory error: out of bound pointer
KLEE: WARNING ONCE: calling external: SHA256_Update(59051440, 58599440, 26) at /home/klee/red_velvet.c:224
KLEE: WARNING ONCE: calling external: SHA256_Final(59051152, 59051440) at /home/klee/red_velvet.c:225

KLEE: <span style="color:#fff;font-weight:bold">done</span>: total instructions = <span style="color:#ff0;font-weight:bold">115768</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: completed paths = <span style="color:#ff0;font-weight:bold">57</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: generated tests = <span style="color:#ff0;font-weight:bold">57</span>
$ ls klee-last | grep err
test000003.div.err
test000006.div.err
test000008.div.err
test000056.ptr.err
$ ktest-tool --write-ints klee-last/test000056.ktest 
ktest file : <span style="color:#0ff;font-weight:bold">&#39;klee-last/test000056.ktest&#39;</span>
args       : [<span style="color:#0ff;font-weight:bold">&#39;red_velvet.bc&#39;</span>]
num objects: <span style="color:#ff0;font-weight:bold">2</span>
object    0: name: b<span style="color:#0ff;font-weight:bold">&#39;model_version&#39;</span>
object    0: size: <span style="color:#ff0;font-weight:bold">4</span>
object    0: data: <span style="color:#ff0;font-weight:bold">1</span>
object    1: name: b<span style="color:#0ff;font-weight:bold">&#39;buf&#39;</span>
object    1: size: <span style="color:#ff0;font-weight:bold">27</span>
object    1: data: b<span style="color:#0ff;font-weight:bold">&#39;What_You_Wanna_Be?:)_l`_la\x01&#39;</span>
</code></pre></div><p>As we can see above the external functions were called, still the checksum didn&rsquo;t succeed. However, it wasn&rsquo;t only because the valid solution found wasn&rsquo;t the expected one.</p>
<p>If I want I can actually modify the code by changing the function <code>func14</code> as shown below to force the constraint solver to find the solution we want, that is, the solution that will be valid according to the checksum.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#fff;font-weight:bold">int</span>  func14(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#007f7f">/* check to make it accept only one solution */</span>
  <span style="color:#fff;font-weight:bold">if</span>(a2 != <span style="color:#ff0;font-weight:bold">97</span>)
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
</code></pre></div><p>Anyway, if you run it you will see that despite the solution being valid the KLEE assert is not reached. Why? Well the code for validating the checksum really sucks, if you print the strings being compared you&rsquo;ll see that actually when the <code>strcmp</code> happens one of the strings is messed up. I fixed that too, see <a href="https://github.com/houseofxyz/symbolic-execution/blob/master/CTF-RedVelvet/red_velvet.checksum.fixed.c">here</a>. However, for some reasons even though after KLEE finds the desired solution the checksum is still wrong. See below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clang -emit-llvm -g -c red_velvet.checksum.fixed.c -DKLEE
$ klee --optimize -load=/usr/lib/x86_64-linux-gnu/libssl.so -load=/usr/lib/x86_64-linux-gnu/libcrypto.so --libc=uclibc --posix-runtime -allow-external-sym-calls -emit-all-errors red_velvet.checksum.fixed.bc
KLEE: NOTE: Using klee-uclibc : /home/klee/klee_build/klee/Release+Debug+Asserts/lib/klee-uclibc.bca
KLEE: NOTE: Using model: /home/klee/klee_build/klee/Release+Debug+Asserts/lib/libkleeRuntimePOSIX.bca
KLEE: output directory is <span style="color:#0ff;font-weight:bold">&#34;/home/klee/klee-out-6&#34;</span>
KLEE: Using STP solver backend
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Final
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Init
KLEE: WARNING: undefined reference to <span style="color:#fff;font-weight:bold">function</span>: SHA256_Update
KLEE: WARNING ONCE: calling external: syscall(16, 0, 21505, 71898288) at /home/klee/klee_src/runtime/POSIX/fd.c:980
KLEE: WARNING ONCE: Alignment of memory from call <span style="color:#0ff;font-weight:bold">&#34;malloc&#34;</span> is not modelled. Using alignment of 8.
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.checksum.fixed.c:21: divide by zero
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.checksum.fixed.c:30: divide by zero
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.checksum.fixed.c:41: divide by zero
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
KLEE: WARNING ONCE: calling external: SHA256_Init(54017408) at /home/klee/red_velvet.checksum.fixed.c:202
KLEE: WARNING ONCE: calling external: SHA256_Update(54017408, 68083424, 26) at /home/klee/red_velvet.checksum.fixed.c:203
KLEE: WARNING ONCE: calling external: SHA256_Final(73422336, 54017408) at /home/klee/red_velvet.checksum.fixed.c:204
KLEE: WARNING ONCE: calling external: printf(64453968, 54018336) at /home/klee/red_velvet.checksum.fixed.c:207
s1= 659d36ca563ba4622daabb36a71dafaf6060cdcbf89bb12e75426198496d272c
s2= 0a435f46288bb5a764d13fca6c901d3750cee73fd7689ce79ef6dc0ff8f380e5
buf=
KLEE: ERROR: /home/klee/red_velvet.checksum.fixed.c:213: ASSERTION FAIL: <span style="color:#ff0;font-weight:bold">0</span>

KLEE: <span style="color:#fff;font-weight:bold">done</span>: total instructions = <span style="color:#ff0;font-weight:bold">115625</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: completed paths = <span style="color:#ff0;font-weight:bold">57</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: generated tests = <span style="color:#ff0;font-weight:bold">57</span>
$ ls klee-last/*err
klee-last/test000003.div.err  klee-last/test000006.div.err  klee-last/test000008.div.err  klee-last/test000057.assert.err
$ ktest-tool --write-ints --trim-zeros klee-last/test000057.ktest
ktest file : <span style="color:#0ff;font-weight:bold">&#39;klee-last/test000057.ktest&#39;</span>
args       : [<span style="color:#0ff;font-weight:bold">&#39;red_velvet.checksum.fixed.bc&#39;</span>]
num objects: <span style="color:#ff0;font-weight:bold">2</span>
object    0: name: b<span style="color:#0ff;font-weight:bold">&#39;model_version&#39;</span>
object    0: size: <span style="color:#ff0;font-weight:bold">4</span>
object    0: data: <span style="color:#ff0;font-weight:bold">1</span>
object    1: name: b<span style="color:#0ff;font-weight:bold">&#39;buf&#39;</span>
object    1: size: <span style="color:#ff0;font-weight:bold">27</span>
object    1: data: b<span style="color:#0ff;font-weight:bold">&#39;What_You_Wanna_Be?:)_la_la\x00&#39;</span>
</code></pre></div><p>Why it is wrong I don&rsquo;t know. Above I print both checksums and I used <code>klee_assume( strcmp(s1, s2) != 0);</code> to hit the assert and create our solution file. While the checksum for <code>What_You_Wanna_Be?:)_la_la</code> is correct, the other that comes from KLEE it&rsquo;s not. I checked if it was actually the checksum of <code>What_You_Wanna_Be?:)_la_la\x00</code> but it is not. Anyway, I spent too much time on this checksum already. If you know why this happens please let me know.</p>
<p>So, what to do? Easy. Delete all the checksum routines. This code is actually a very big hack and really buggy. So let&rsquo;s remove the checksum routines.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;stdio.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;stdlib.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;string.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;defs.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;assert.h&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;./klee_src/include/klee/klee.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">int</span>  func1(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 * <span style="color:#ff0;font-weight:bold">2</span> * (<span style="color:#fff;font-weight:bold">char</span>)(a2 ^ a1) - a2 != <span style="color:#ff0;font-weight:bold">10858</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt;= <span style="color:#ff0;font-weight:bold">85</span> || a1 &gt; <span style="color:#ff0;font-weight:bold">95</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">96</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">111</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func2(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 % a2 != <span style="color:#ff0;font-weight:bold">7</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt;= <span style="color:#ff0;font-weight:bold">90</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func3(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 / a2 + (<span style="color:#fff;font-weight:bold">char</span>)(a2 ^ a1) != <span style="color:#ff0;font-weight:bold">21</span> || a1 &gt; <span style="color:#ff0;font-weight:bold">99</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">119</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func4(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">signed</span> <span style="color:#fff;font-weight:bold">__int64</span> v2; <span style="color:#007f7f">// rtt@1
</span><span style="color:#007f7f"></span>
  LODWORD(v2) = (<span style="color:#fff;font-weight:bold">char</span>)(a2 ^ a1 ^ a2);
  HIDWORD(v2) = (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">__int64</span>)(<span style="color:#fff;font-weight:bold">char</span>)(a2 ^ a1 ^ a2) &gt;&gt; <span style="color:#ff0;font-weight:bold">32</span>;
  <span style="color:#fff;font-weight:bold">if</span> ( (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)(v2 % a2) + a1 != <span style="color:#ff0;font-weight:bold">137</span> || a1 &lt;= <span style="color:#ff0;font-weight:bold">115</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">99</span> || a2 != <span style="color:#ff0;font-weight:bold">95</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func5(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2)
{
  <span style="color:#fff;font-weight:bold">if</span> ( ((a2 + a1) ^ (<span style="color:#fff;font-weight:bold">char</span>)(a1 ^ a2 ^ a1)) != <span style="color:#ff0;font-weight:bold">225</span> || a1 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">89</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func6(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &gt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt;= <span style="color:#ff0;font-weight:bold">85</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">110</span> || a3 &lt;= <span style="color:#ff0;font-weight:bold">115</span> || ((a2 + a3) ^ (a1 + a2)) != <span style="color:#ff0;font-weight:bold">44</span> || (a2 + a3) % a1 + a2 != <span style="color:#ff0;font-weight:bold">161</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func7(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &gt; <span style="color:#ff0;font-weight:bold">119</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a3 &gt; <span style="color:#ff0;font-weight:bold">89</span> || ((a1 + a3) ^ (a2 + a3)) != <span style="color:#ff0;font-weight:bold">122</span> || (a1 + a3) % a2 + a3 != <span style="color:#ff0;font-weight:bold">101</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func8(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &gt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a3 &gt; <span style="color:#ff0;font-weight:bold">114</span> || (a1 + a2) / a3 * a2 != <span style="color:#ff0;font-weight:bold">97</span> || (a3 ^ (a1 - a2)) * a2 != -<span style="color:#ff0;font-weight:bold">10088</span> || a3 &gt; <span style="color:#ff0;font-weight:bold">114</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func9(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 != a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a3 &gt; <span style="color:#ff0;font-weight:bold">99</span> || a3 + a1 * (a3 - a2) - a1 != -<span style="color:#ff0;font-weight:bold">1443</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func10(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 * (a1 + a3 + <span style="color:#ff0;font-weight:bold">1</span>) - a3 != <span style="color:#ff0;font-weight:bold">15514</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">99</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func11(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a1 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt;= <span style="color:#ff0;font-weight:bold">100</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">104</span> || a1 + (a2 ^ (a2 - a3)) - a3 != <span style="color:#ff0;font-weight:bold">70</span> || (a2 + a3) / a1 + a1 != <span style="color:#ff0;font-weight:bold">68</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func12(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; <span style="color:#ff0;font-weight:bold">59</span> || a3 &gt; <span style="color:#ff0;font-weight:bold">44</span> || a1 + (a2 ^ (a3 + a2)) - a3 != <span style="color:#ff0;font-weight:bold">111</span> || (a2 ^ (a2 - a3)) + a2 != <span style="color:#ff0;font-weight:bold">101</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func13(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &gt; a2 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt;= <span style="color:#ff0;font-weight:bold">40</span> || a2 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a3 &gt; <span style="color:#ff0;font-weight:bold">109</span> || a3 + (a2 ^ (a3 + a1)) - a1 != <span style="color:#ff0;font-weight:bold">269</span> || (a3 ^ (a2 - a1)) + a2 != <span style="color:#ff0;font-weight:bold">185</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func14(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a1 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &gt; <span style="color:#ff0;font-weight:bold">99</span> || a3 &lt;= <span style="color:#ff0;font-weight:bold">90</span> || a1 + (a2 ^ (a2 + a1)) - a3 != <span style="color:#ff0;font-weight:bold">185</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span>  func15(<span style="color:#fff;font-weight:bold">char</span> a1, <span style="color:#fff;font-weight:bold">char</span> a2, <span style="color:#fff;font-weight:bold">char</span> a3)
{
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a3 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a2 &lt; a1 )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">if</span> ( a3 &lt;= <span style="color:#ff0;font-weight:bold">95</span> || a2 &gt; <span style="color:#ff0;font-weight:bold">109</span> || ((a2 - a1) * a2 ^ a3) - a1 != <span style="color:#ff0;font-weight:bold">1214</span> || ((a3 - a2) * a3 ^ a1) + a2 != -<span style="color:#ff0;font-weight:bold">1034</span> )
    exit(<span style="color:#ff0;font-weight:bold">1</span>);
  <span style="color:#fff;font-weight:bold">return</span> puts(<span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)&#34;</span>);
}

<span style="color:#fff;font-weight:bold">int</span> main(<span style="color:#fff;font-weight:bold">int</span> argc, <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> **argv, <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">char</span> **envp)
{
  <span style="color:#fff;font-weight:bold">char</span> buf[<span style="color:#ff0;font-weight:bold">27</span>];

<span style="color:#0f0;font-weight:bold">#ifdef KLEE
</span><span style="color:#0f0;font-weight:bold"></span>  klee_make_symbolic(buf, <span style="color:#fff;font-weight:bold">sizeof</span>(buf), <span style="color:#0ff;font-weight:bold">&#34;buf&#34;</span>);
<span style="color:#0f0;font-weight:bold">#else
</span><span style="color:#0f0;font-weight:bold"></span>  printf(<span style="color:#0ff;font-weight:bold">&#34;Your flag : &#34;</span>);
  fgets(buf, <span style="color:#ff0;font-weight:bold">27</span>, stdin);
<span style="color:#0f0;font-weight:bold">#endif
</span><span style="color:#0f0;font-weight:bold"></span>  func1((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">0</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">1</span>]);
  func2((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">1</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">2</span>]);
  func3((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">2</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">3</span>]);
  func4((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">3</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">4</span>]);
  func5((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">4</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">5</span>]);
  func6((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">5</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">6</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">7</span>]);
  func7((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">7</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">8</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">9</span>]);
  func8((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">9</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">10</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">11</span>]);
  func9((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">11</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">12</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">13</span>]);
  func10((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">13</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">14</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">15</span>]);
  func11((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">15</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">16</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">17</span>]);
  func12((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">17</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">18</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">19</span>]);
  func13((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">19</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">20</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">21</span>]);
  func14((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">21</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">22</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">23</span>]);
  func15((<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">23</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">24</span>], (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">int</span>)buf[<span style="color:#ff0;font-weight:bold">25</span>]);

<span style="color:#0f0;font-weight:bold">#ifdef KLEE
</span><span style="color:#0f0;font-weight:bold"></span>  klee_assert(<span style="color:#ff0;font-weight:bold">0</span>);
<span style="color:#0f0;font-weight:bold">#else
</span><span style="color:#0f0;font-weight:bold"></span>  printf(<span style="color:#0ff;font-weight:bold">&#34;flag : {</span><span style="color:#0ff;font-weight:bold">\&#34;</span><span style="color:#0ff;font-weight:bold"> %s </span><span style="color:#0ff;font-weight:bold">\&#34;</span><span style="color:#0ff;font-weight:bold">}</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>, buf);
<span style="color:#0f0;font-weight:bold">#endif
</span><span style="color:#0f0;font-weight:bold"></span>  <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
}
</code></pre></div><p>If we run it with KLEE now&hellip;</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clang -emit-llvm -g -c red_velvet.c -DKLEE
klee@98643f6c5c8a:~$ klee --optimize --libc=uclibc --posix-runtime -allow-external-sym-calls -emit-all-errors red_velvet.bc
KLEE: NOTE: Using klee-uclibc : /home/klee/klee_build/klee/Release+Debug+Asserts/lib/klee-uclibc.bca
KLEE: NOTE: Using model: /home/klee/klee_build/klee/Release+Debug+Asserts/lib/libkleeRuntimePOSIX.bca
KLEE: output directory is <span style="color:#0ff;font-weight:bold">&#34;/home/klee/klee-out-37&#34;</span>
KLEE: Using STP solver backend
KLEE: WARNING ONCE: calling external: syscall(16, 0, 21505, 45360912) at /home/klee/klee_src/runtime/POSIX/fd.c:980
KLEE: WARNING ONCE: Alignment of memory from call <span style="color:#0ff;font-weight:bold">&#34;malloc&#34;</span> is not modelled. Using alignment of 8.
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:20: divide by zero
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:29: divide by zero
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:40: divide by zero
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
KLEE: ERROR: /home/klee/red_velvet.c:190: ASSERTION FAIL: <span style="color:#ff0;font-weight:bold">0</span>

KLEE: <span style="color:#fff;font-weight:bold">done</span>: total instructions = <span style="color:#ff0;font-weight:bold">5811</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: completed paths = <span style="color:#ff0;font-weight:bold">56</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: generated tests = <span style="color:#ff0;font-weight:bold">56</span>
$ ls klee-last | grep err
test000003.div.err
test000006.div.err
test000008.div.err
test000056.assert.err
$ ktest-tool --write-ints klee-last/test000056.ktest
ktest file : <span style="color:#0ff;font-weight:bold">&#39;klee-last/test000056.ktest&#39;</span>
args       : [<span style="color:#0ff;font-weight:bold">&#39;red_velvet.bc&#39;</span>]
num objects: <span style="color:#ff0;font-weight:bold">2</span>
object    0: name: b<span style="color:#0ff;font-weight:bold">&#39;model_version&#39;</span>
object    0: size: <span style="color:#ff0;font-weight:bold">4</span>
object    0: data: <span style="color:#ff0;font-weight:bold">1</span>
object    1: name: b<span style="color:#0ff;font-weight:bold">&#39;buf&#39;</span>
object    1: size: <span style="color:#ff0;font-weight:bold">27</span>
object    1: data: b<span style="color:#0ff;font-weight:bold">&#39;What_You_Wanna_Be?:)_l`_la\x00&#39;</span>
</code></pre></div><p>Our KLEE assert is finally reached. If you list the files inside <code>klee-last</code>, you&rsquo;ll see multiple <code>ktest</code> files which are basically the test cases generated by KLEE.</p>
<p>If we didn&rsquo;t want to go over the hassle of removing the checksum code, we could also have simply made the modification below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#f00">$</span> diff -uN red_velvet<span style="color:#ff0;font-weight:bold">.0</span>.c red_velvet<span style="color:#ff0;font-weight:bold">.1</span>.c
--- red_velvet<span style="color:#ff0;font-weight:bold">.0</span>.c      <span style="color:#ff0;font-weight:bold">2018</span>-<span style="color:#ff0;font-weight:bold">05</span>-<span style="color:#ff0;font-weight:bold">17</span> <span style="color:#ff0;font-weight:bold">18</span>:<span style="color:#ff0;font-weight:bold">50</span>:<span style="color:#ff0;font-weight:bold">17.989838225</span> +<span style="color:#ff0;font-weight:bold">0000</span>
+++ red_velvet<span style="color:#ff0;font-weight:bold">.1</span>.c      <span style="color:#ff0;font-weight:bold">2018</span>-<span style="color:#ff0;font-weight:bold">05</span>-<span style="color:#ff0;font-weight:bold">17</span> <span style="color:#ff0;font-weight:bold">18</span>:<span style="color:#ff0;font-weight:bold">51</span>:<span style="color:#ff0;font-weight:bold">06.711161145</span> +<span style="color:#ff0;font-weight:bold">0000</span>
<span style="color:#f00">@@</span> -<span style="color:#ff0;font-weight:bold">222</span>,<span style="color:#ff0;font-weight:bold">8</span> +<span style="color:#ff0;font-weight:bold">222</span>,<span style="color:#ff0;font-weight:bold">7</span> <span style="color:#f00">@@</span>
   SHA256_Final(v38, &amp;v11);
   <span style="color:#fff;font-weight:bold">for</span> ( i = <span style="color:#ff0;font-weight:bold">0</span>; i &lt;= <span style="color:#ff0;font-weight:bold">31</span>; ++i )
     sprintf(&amp;s1[<span style="color:#ff0;font-weight:bold">2</span> * i], <span style="color:#0ff;font-weight:bold">&#34;%02x&#34;</span>, (<span style="color:#fff;font-weight:bold">unsigned</span> <span style="color:#fff;font-weight:bold">__int8</span>)v38[i]);
-  <span style="color:#fff;font-weight:bold">if</span> ( strcmp(s1, s2) )
-    exit(<span style="color:#ff0;font-weight:bold">1</span>);
+  klee_assume( strcmp(s1, s2) == <span style="color:#ff0;font-weight:bold">0</span>);
 <span style="color:#0f0;font-weight:bold">#ifdef KLEE
</span><span style="color:#0f0;font-weight:bold"></span>   klee_assert(<span style="color:#ff0;font-weight:bold">0</span>);
 <span style="color:#0f0;font-weight:bold">#else
</span></code></pre></div><p>This was a good example to face some of the limitations of KLEE.</p>
<h3 id="find-the-serial-number-1">Find the serial number</h3>
<p>The basic serial number example will allow us to see a couple of more things while using KLEE. First, instead of using <code>klee_make_symbolic()</code> to make the user input symbolic we can just leave it and make the command-line argument symbolic with the option <code>--sym-arg</code>, in this case it will look for solutions that are under 11 chars.</p>
<p>For reference, in &ldquo;real&rdquo; programs the number of code paths can be extremely big if not infinite. This means KLEE will not terminate and it will run until we press <code>Ctrl+C</code> (SIGINT). We can use <code>-max-time=&lt;num seconds&gt;</code>, <code>-max-forks=N</code> (stop forking after N symbolic branches) and <code>-max-memory=N</code> (limit the memory consumption to N bytes) to have some control over KLEE.</p>
<p>The only change we did to the original source code <code>sn.c</code> file was the one below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#f00">$</span> diff -uN sn.orig.c sn.c 
--- sn.orig.c <span style="color:#ff0;font-weight:bold">2018</span>-<span style="color:#ff0;font-weight:bold">05</span>-<span style="color:#ff0;font-weight:bold">18</span> <span style="color:#ff0;font-weight:bold">19</span>:<span style="color:#ff0;font-weight:bold">01</span>:<span style="color:#ff0;font-weight:bold">26.578303833</span> +<span style="color:#ff0;font-weight:bold">0000</span>
+++ sn.c  <span style="color:#ff0;font-weight:bold">2018</span>-<span style="color:#ff0;font-weight:bold">05</span>-<span style="color:#ff0;font-weight:bold">18</span> <span style="color:#ff0;font-weight:bold">19</span>:<span style="color:#ff0;font-weight:bold">00</span>:<span style="color:#ff0;font-weight:bold">27.068119927</span> +<span style="color:#ff0;font-weight:bold">0000</span>
<span style="color:#f00">@@</span> -<span style="color:#ff0;font-weight:bold">82</span>,<span style="color:#ff0;font-weight:bold">10</span> +<span style="color:#ff0;font-weight:bold">82</span>,<span style="color:#ff0;font-weight:bold">13</span> <span style="color:#f00">@@</span>
     usage(argv[<span style="color:#ff0;font-weight:bold">0</span>]);
 
   <span style="color:#fff;font-weight:bold">if</span> (validate_sn(serial))
+<span style="color:#f00">#</span>ifdef KLEE
+    klee_assert(<span style="color:#ff0;font-weight:bold">0</span>);
+<span style="color:#f00">#</span><span style="color:#fff;font-weight:bold">else</span>
     printf(<span style="color:#0ff;font-weight:bold">&#34;Thank You. Your license is now active.</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>);
   <span style="color:#fff;font-weight:bold">else</span>
     printf(<span style="color:#0ff;font-weight:bold">&#34;Invalid Serial Number. Please try again.</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span>);
-
+<span style="color:#f00">#</span>endif
   <span style="color:#fff;font-weight:bold">return</span> <span style="color:#ff0;font-weight:bold">0</span>;
 }
</code></pre></div><p>We ran it as below.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ clang -emit-llvm -g -c sn.c -DKLEE
$ <span style="color:#fff;font-weight:bold">time</span> klee -emit-all-errors --libc=uclibc --posix-runtime sn.bc --sym-arg <span style="color:#ff0;font-weight:bold">11</span>
KLEE: NOTE: Using klee-uclibc : /home/klee/klee_build/klee/Release+Debug+Asserts/lib/klee-uclibc.bca
KLEE: NOTE: Using model: /home/klee/klee_build/klee/Release+Debug+Asserts/lib/libkleeRuntimePOSIX.bca
KLEE: output directory is <span style="color:#0ff;font-weight:bold">&#34;/home/klee/klee-out-23&#34;</span>
KLEE: Using STP solver backend
KLEE: WARNING ONCE: calling external: syscall(16, 0, 21505, 48856800) at /home/klee/klee_src/runtime/POSIX/fd.c:980
KLEE: WARNING ONCE: calling __user_main with extra arguments.
KLEE: WARNING ONCE: Alignment of memory from call <span style="color:#0ff;font-weight:bold">&#34;malloc&#34;</span> is not modelled. Using alignment of 8.
KLEE: ERROR: /home/klee/sn.c:86: ASSERTION FAIL: <span style="color:#ff0;font-weight:bold">0</span>

KLEE: <span style="color:#fff;font-weight:bold">done</span>: total instructions = <span style="color:#ff0;font-weight:bold">6158</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: completed paths = <span style="color:#ff0;font-weight:bold">25</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: generated tests = <span style="color:#ff0;font-weight:bold">25</span>

real  0m0.732s
user  0m0.536s
sys 0m0.191s
$ ls klee-last/*err  
klee-last/test000024.assert.err
$ ktest-tool --write-ints --trim-zeros klee-last/test000024.ktest 
ktest file : <span style="color:#0ff;font-weight:bold">&#39;klee-last/test000024.ktest&#39;</span>
args       : [<span style="color:#0ff;font-weight:bold">&#39;sn.bc&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;--sym-arg&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;11&#39;</span>]
num objects: <span style="color:#ff0;font-weight:bold">2</span>
object    0: name: b<span style="color:#0ff;font-weight:bold">&#39;arg0&#39;</span>
object    0: size: <span style="color:#ff0;font-weight:bold">12</span>
object    0: data: b<span style="color:#0ff;font-weight:bold">&#39;10A00-50A00\x00&#39;</span>
object    1: name: b<span style="color:#0ff;font-weight:bold">&#39;model_version&#39;</span>
object    1: size: <span style="color:#ff0;font-weight:bold">4</span>
object    1: data: <span style="color:#ff0;font-weight:bold">1</span>
</code></pre></div><p>We now have 25 execution paths, we also have 25 test cases. We can replay these test cases, but we won&rsquo;t look into that today. Refer to KLEE&rsquo;s <a href="http://klee.github.io/tutorials/testing-function/">documentation</a> if you want to know more.</p>
<p>We know there are more possible &ldquo;solutions&rdquo; than the one above. KLEE is deterministic, which means that if you run it again you&rsquo;ll get the same result. There are a couple of &ldquo;hacks&rdquo; we can try to get different results, but I won&rsquo;t follow that path. You can try the <a href="https://mailman.ic.ac.uk/mailman/listinfo/klee-dev">KLEE-DEV mailing list</a> for options. One easy thing you can do is to use a different solver than the default one, <a href="https://stp.github.io/">STP</a>. For example, we can use Z3. Actually, it&rsquo;s not uncommon to use a multiple solvers to increase performance.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> klee -emit-all-errors --libc=uclibc --posix-runtime -solver-backend=z3 sn.bc --sym-arg <span style="color:#ff0;font-weight:bold">11</span>
KLEE: NOTE: Using klee-uclibc : /home/klee/klee_build/klee/Release+Debug+Asserts/lib/klee-uclibc.bca
KLEE: NOTE: Using model: /home/klee/klee_build/klee/Release+Debug+Asserts/lib/libkleeRuntimePOSIX.bca
KLEE: output directory is <span style="color:#0ff;font-weight:bold">&#34;/home/klee/klee-out-24&#34;</span>
KLEE: Using Z3 solver backend
KLEE: WARNING ONCE: calling external: syscall(16, 0, 21505, 55623456) at /home/klee/klee_src/runtime/POSIX/fd.c:980
KLEE: WARNING ONCE: calling __user_main with extra arguments.
KLEE: WARNING ONCE: Alignment of memory from call <span style="color:#0ff;font-weight:bold">&#34;malloc&#34;</span> is not modelled. Using alignment of 8.
KLEE: ERROR: /home/klee/sn.c:86: ASSERTION FAIL: <span style="color:#ff0;font-weight:bold">0</span>

KLEE: <span style="color:#fff;font-weight:bold">done</span>: total instructions = <span style="color:#ff0;font-weight:bold">6158</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: completed paths = <span style="color:#ff0;font-weight:bold">25</span>
KLEE: <span style="color:#fff;font-weight:bold">done</span>: generated tests = <span style="color:#ff0;font-weight:bold">25</span>

real  0m0.612s
user  0m0.583s
sys 0m0.028s
$ ls klee-last/*err
klee-last/test000024.assert.err
$ ktest-tool --write-ints klee-last/test000024.ktest 
ktest file : <span style="color:#0ff;font-weight:bold">&#39;klee-last/test000024.ktest&#39;</span>
args       : [<span style="color:#0ff;font-weight:bold">&#39;sn.bc&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;--sym-arg&#39;</span>, <span style="color:#0ff;font-weight:bold">&#39;11&#39;</span>]
num objects: <span style="color:#ff0;font-weight:bold">2</span>
object    0: name: b<span style="color:#0ff;font-weight:bold">&#39;arg0&#39;</span>
object    0: size: <span style="color:#ff0;font-weight:bold">12</span>
object    0: data: b<span style="color:#0ff;font-weight:bold">&#39;12K22-52K222&#39;</span>
object    1: name: b<span style="color:#0ff;font-weight:bold">&#39;model_version&#39;</span>
object    1: size: <span style="color:#ff0;font-weight:bold">4</span>
object    1: data: <span style="color:#ff0;font-weight:bold">1</span>
</code></pre></div><p>Which generated a different valid SN number, in this case actually a bit faster than <a href="http://stp.github.io/">STP</a>. You can find more about what solvers and solver options you can play with <a href="http://klee.github.io/docs/solver-chain/">here</a>.</p>
<h2 id="angr">angr</h2>
<p>What is <a href="http://angr.io/">angr</a>? angr is a framework for analyzing binaries, with the capability to perform dynamic symbolic execution (like KLEE, etc) and various static analyses on binaries. It is very popular among the CTF community, since <a href="https://github.com/shellphish">Shellphish</a> has used angr in many CTFs successfully. If you are already familiar with angr, probably you want to skip this part.</p>
<p>I find angr very interesting as it focuses on both static and dynamic symbolic (&ldquo;concolic&rdquo;) analysis, making it applicable to a variety of tasks. It is complex though, as any other tool in this area anyway. Their <a href="https://docs.angr.io/">documentation</a> is very good and I definitely recommend you to go through it if you want to know more than what we&rsquo;ll see here.</p>
<p>We&rsquo;ll look again at the RedVelvet binary from the CODEGATE CTF. We already reversed it, and we used IDA Pro Hex-Rays decompiler to look at its pseudo code. If we don&rsquo;t read the pseudo code carefully, we might think at first that if we pass all the 15 validation functions we get our flag. And that was my first thought. I could try to print <code>HAPPINESS:)</code> 15 times&hellip;</p>
<p>We&rsquo;ll use angr docker image. If you aren&rsquo;t familiar with docker, below I get the angr image, I start a container, I copy our RedVelvet binary to the container, and I connect back to the container.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker pull angr/angr
$ docker run -it angr/angr
(angr) angr@66fb14721ee2:~$ <span style="color:#fff;font-weight:bold">exit</span>
<span style="color:#fff;font-weight:bold">logout</span>
$ docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                      PORTS               NAMES
66fb14721ee2        angr/angr           <span style="color:#0ff;font-weight:bold">&#34;/bin/sh -c &#39;su - ...&#34;</span>   <span style="color:#ff0;font-weight:bold">35</span> minutes ago      Exited (0) <span style="color:#ff0;font-weight:bold">17</span> minutes ago                       fervent_northcutt
$ docker cp ~/CTFs/2018/CODEGATE/RedVelvet fervent_northcutt:/home/angr/
$ docker start -ai 66fb14721ee2
(angr) angr@66fb14721ee2:~$ ls
RedVelvet  angr-dev
</code></pre></div><p>So I looked at <a href="https://docs.angr.io/docs/pathgroups.html">angr documentation</a> and found something that might work and it&rsquo;s almost a copy and paste. <em>&ldquo;The most important control interface in angr is the SimulationManager, which allows you to control symbolic execution over groups of states simultaneously, applying search strategies to explore a program&rsquo;s state space.&quot;</em> And little down on the same page we have a <code>crackme</code> example.</p>
<p><em>First, we load the binary.</em></p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">&gt;&gt;&gt; proj = angr.Project(<span style="color:#0ff;font-weight:bold">&#39;examples/CSCI-4968-MBE/challenges/crackme0x00a/crackme0x00a&#39;</span>)
</code></pre></div><p><em>Next, we create a <code>SimulationManager</code>.</em></p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">&gt;&gt;&gt; simgr = proj.factory.simgr()
</code></pre></div><p><em>Now, we symbolically execute until we find a state that matches our condition (i.e., the <code>win</code> condition).</em></p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">&gt;&gt;&gt; simgr.explore(find=<span style="color:#fff;font-weight:bold">lambda</span> s: <span style="color:#0ff;font-weight:bold">&#34;Congrats&#34;</span> in s.posix.dumps(<span style="color:#ff0;font-weight:bold">1</span>))
&lt;SimulationManager <span style="color:#fff;font-weight:bold">with</span> <span style="color:#ff0;font-weight:bold">1</span> active, <span style="color:#ff0;font-weight:bold">1</span> found&gt;
</code></pre></div><p><em>Now, we can get the flag out of that state!</em></p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">&gt;&gt;&gt; s = simgr.found[<span style="color:#ff0;font-weight:bold">0</span>]
&gt;&gt;&gt; <span style="color:#fff;font-weight:bold">print</span> s.posix.dumps(<span style="color:#ff0;font-weight:bold">1</span>)
Enter password: Congrats<span style="color:#f00">!</span>

&gt;&gt;&gt; flag = s.posix.dumps(<span style="color:#ff0;font-weight:bold">0</span>)
&gt;&gt;&gt; <span style="color:#fff;font-weight:bold">print</span>(flag)
g00dJ0B<span style="color:#f00">!</span>
</code></pre></div><p>Pretty simple, isn&rsquo;t it? Well, it looks like.</p>
<p>I create the script below, which is basically a copy of the documentation.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">import</span> angr

proj = angr.Project(<span style="color:#0ff;font-weight:bold">&#34;./RedVelvet&#34;</span>)
simgr = proj.factory.simgr()
simgr.explore(find=<span style="color:#fff;font-weight:bold">lambda</span> s: <span style="color:#0ff;font-weight:bold">&#34;HAPPINESS:)</span><span style="color:#0ff;font-weight:bold">\n</span><span style="color:#0ff;font-weight:bold">&#34;</span> * <span style="color:#ff0;font-weight:bold">15</span> in s.posix.dumps(<span style="color:#ff0;font-weight:bold">1</span>))
s = simgr.found[<span style="color:#ff0;font-weight:bold">0</span>]
<span style="color:#fff;font-weight:bold">print</span> s.posix.dumps(<span style="color:#ff0;font-weight:bold">1</span>)
flag = s.posix.dumps(<span style="color:#ff0;font-weight:bold">0</span>)[:<span style="color:#ff0;font-weight:bold">26</span>]
<span style="color:#fff;font-weight:bold">print</span> flag
</code></pre></div><p>Let&rsquo;s try it.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> python red.angr.1.py
WARNING | 2018-05-19 09:34:37,083 | angr.procedures.definitions | unsupported syscall: ptrace
WARNING | 2018-05-19 09:34:43,210 | angr.engines.successors | Exit state has over <span style="color:#ff0;font-weight:bold">256</span> possible solutions. Likely unconstrained; skipping. &lt;BV64 reg_28_4_64&gt;
</code></pre></div><p>Hmm, after 10 minutes it was still running&hellip; so I hit <code>Ctrl+C</code>. We can see <code>ptrace</code> is unsupported and most likely it&rsquo;s only creating overhead and increasing complexity. Looking at the code I don&rsquo;t even know why it is used, probably just to annoy us. So let&rsquo;s patch the binary to remove that call. Open the binary in IDA Pro, I assume you have <a href="https://github.com/keystone-engine/keypatch">Keypatch plugin</a> installed. If you don&rsquo;t, just follow the instruction on GitHub. Locate the <code>ptrace</code> call and fill it with <code>nops</code>.</p>
<p><img src="/z3/patch.ptrace.1.png" alt=""></p>
<p>Right click over the <code>ptrace</code> call.</p>
<p><img src="/z3/patch.ptrace.2.png" alt=""></p>
<p><img src="/z3/patch.ptrace.3.png" alt=""></p>
<p>Nothing special. You just need to adjust the <code>JNZ</code> instruction to follow the desired path. Simply change it from <code>JNZ</code> to <code>JMP</code> and that&rsquo;s it. In the end it should look like this.</p>
<p><img src="/z3/patch.ptrace.4.png" alt=""></p>
<p>Finally, save your modified binary.</p>
<p><img src="/z3/patch.ptrace.5.png" alt=""></p>
<p>And, it&rsquo;s always a good idea to check if it still works.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ./RedVelvet.noptrace
Your flag : What the hack
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
</code></pre></div><p>It doesn&rsquo;t crash. Should be good. Let&rsquo;s try with this binary instead.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker cp ~/CTFs/2018/CODEGATE/RedVelvet.noptrace fervent_northcutt:/home/angr/
$ docker start -ai 66fb14721ee2
(angr) angr@66fb14721ee2:~$ ls
RedVelvet  RedVelvet.noptrace  angr-dev  red.angr.1.py
</code></pre></div><p>I changed the script to load this binary and I run it again.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> python red.angr.1.py
Your flag : HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)
HAPPINESS:)

What_You_Wanna_Be?:)_lc_la

real    3m38.992s
user    3m37.447s
sys     0m1.503s
</code></pre></div><p>Nice, it worked. In terms of execution it was slower than Z3 or KLEE, but definitely a lot faster overall. I mean, writing this script was trivial. Took me more time looking at the documentation than typing the script.</p>
<p>While looking at angr&rsquo;s documentation I also found the <a href="https://github.com/angr/angr-doc/blob/master/docs/surveyors.md">following</a> while looking for symbolic execution. <em>&ldquo;At heart, angr is a symbolic execution engine. angr exposes a standard way to write and perform dynamic symbolic execution: the Surveyor class. A Surveyor is the engine that drives symbolic execution: it tracks what paths are active, identifies which paths to step forward and which paths to prune, and optimizes resource allocation.&quot;</em></p>
<p>And, <em>&ldquo;angr.surveyors.Explorer is a Surveyor subclass that implements symbolic exploration. It can be told where to start, where to go, what to avoid, and what paths to stick to. It also tries to avoid getting stuck in loops.&quot;</em></p>
<p>And, in the explorer section, we can read the following.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#007f7f"># This creates an Explorer that tries to find 0x4006ed (successful auth),</span>
<span style="color:#007f7f"># while avoiding 0x4006fd (failed auth) or 0x4006aa (the authentication</span>
<span style="color:#007f7f"># routine). In essense, we are looking for a backdoor.</span>
&gt;&gt;&gt; e = proj.surveyors.Explorer(find=(<span style="color:#ff0;font-weight:bold">0x4006ed</span>,), avoid=(<span style="color:#ff0;font-weight:bold">0x4006aa</span>,<span style="color:#ff0;font-weight:bold">0x4006fd</span>))
</code></pre></div><p>Looks interesting, let&rsquo;s try to play with it. The <code>RedVelvet</code> binary is not loaded into random locations within virtual memory each time it is executed. See, <code>No PIE</code>. Even if it was, it wouldn&rsquo;t be a problem because you could just use offsets plus the base address the angr always uses.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ ./checksec -f ~/CTFs/2018/CODEGATE/RedVelvet
RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FORTIFY Fortified Fortifiable  FILE
Partial RELRO   Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   Yes     <span style="color:#ff0;font-weight:bold">0</span>               <span style="color:#ff0;font-weight:bold">6</span>       /home/rui/CTFs/2018/CODEGATE/RedVelvet
</code></pre></div><p>So it seems we can give this a try. We&rsquo;ll look at the binary in IDA Pro again. According to angr documentation we need to give it the address we are trying to find. We&rsquo;ll be looking at the already patched <code>RedVelvet</code> binary to avoid the <code>ptrace</code> call.</p>
<p><img src="/z3/angr.1.png" alt=""></p>
<p>So if we reach the address above (<code>0x401537</code>), after all the 15 validation function calls, we should be fine. We also need the address we want to avoid. That should be address of the <code>exit</code> calls inside each validation function.</p>
<p>If we enter <code>func1()</code>.</p>
<p><img src="/z3/angr.2.png" alt=""></p>
<p>And we follow the <code>exit</code> call.</p>
<p><img src="/z3/angr.3.png" alt=""></p>
<p>We see that the address we want to avoid is <code>0x4007d0</code>. So here&rsquo;s the script.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#fff;font-weight:bold">import</span> angr

proj = angr.Project(<span style="color:#0ff;font-weight:bold">&#39;RedVelvet.noptrace&#39;</span>)

e = proj.surveyors.Explorer(find=<span style="color:#ff0;font-weight:bold">0x401537</span>, avoid=<span style="color:#ff0;font-weight:bold">0x4007D0</span>)
e.run()
flag = e.found[<span style="color:#ff0;font-weight:bold">0</span>].state.posix.dumps(<span style="color:#ff0;font-weight:bold">0</span>)
<span style="color:#fff;font-weight:bold">print</span> flag[:<span style="color:#ff0;font-weight:bold">26</span>]
</code></pre></div><p>Let&rsquo;s try it.</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#fff;font-weight:bold">time</span> python red.angr.2.py
What_You_Wanna_Be?:)_lc_la

real    3m40.224s
user    3m38.746s
sys     0m1.419s
</code></pre></div><p>It worked, again. More or less the same time as before. We know this is not the correct solution though. Sometimes there are multiple solutions when dealing with constraint solvers as we saw before. It&rsquo;s common they will find solutions that we aren&rsquo;t even aware. In such cases we can modify the constraints to exclude the unwanted solution.</p>
<h2 id="final-notes">Final notes</h2>
<p>Symbolic execution is slow and costly. However, it is undoubtedly powerful. Symbolic execution uses a constraint solver to create inputs/test cases which will exercise a given path in the binary. The main problem with symbolic execution, even though we didn&rsquo;t observe it in this post, is that an approach based only on symbolic execution will succumb to path explosion. As we can easily guess, the number of paths in a real world big binary exponentially increases with each branch.</p>
<p>If you are playing CTFs, getting familiar with angr will definitely help you solve the type of challenges we saw faster. If you are looking at applying symbolic execution to step up your fuzzing/software analysis, I would say have a look at KLEE. Both have advantages and disadvantages depending on the problem you are facing. Both have an eventually long learning curve. KLEE can be a pain to install and it&rsquo;s old LLVM version dependency holds it back a bit. If you are playing CTFs, when using KLEE dealing with symbols and external library calls can be a pain as we saw. Talking about limitations, there&rsquo;s a nice gist <a href="https://gist.github.com/moyix/71357ca3b4d65c13e8394517e7093e21">here</a> from <a href="http://engineering.nyu.edu/faculty/brendan-dolan-gavitt">moyix</a> with some KLEE limitations too, plus some workarounds. Worth reading.</p>
<p>To increase code coverage and bug count &ldquo;everyone&rdquo; is using a combination of tools and techniques in this area, so it&rsquo;s worth knowing the basics. There are many (big) projects out there combining Z3, KLEE, angr, AFL, etc, with impressive results. See the references for more information.</p>
<p>I don&rsquo;t play CTFs very often, my interest in symbolic execution lies in how to apply it to code coverage and fuzzing. At least understand it so, I can make a better use of it. This post documents the first steps if you want to get into this area. All the code snippets used are available at my <a href="https://github.com/houseofxyz/symbolic-execution/">GitLab</a>. Next steps will be looking at <a href="https://triton.quarkslab.com/">Triton</a> and <a href="https://github.com/trailofbits/manticore">Manticore</a> plus all the impressive set of tools that <a href="https://www.trailofbits.com/">Trail of Bits</a> has in this area. I already did a couple of things with these, but this post is way too long already&hellip;</p>
<h4 id="credits">Credits</h4>
<p>Thanks to Luis <a href="https://twitter.com/countuponsec">@countuponsec</a> Rocha for proofreading this post.</p>
<h3 id="references-in-no-particular-order">References (in no particular order)</h3>
<ul>
<li><a href="https://ericpony.github.io/z3py-tutorial/guide-examples.htm">https://ericpony.github.io/z3py-tutorial/guide-examples.htm</a></li>
<li><a href="https://github.com/ericpony/z3py-tutorial">https://github.com/ericpony/z3py-tutorial</a></li>
<li><a href="https://github.com/Z3Prover/z3/wiki/Slides">https://github.com/Z3Prover/z3/wiki/Slides</a></li>
<li><a href="https://rise4fun.com/Z3/tutorial/guide">https://rise4fun.com/Z3/tutorial/guide</a></li>
<li><a href="https://doar-e.github.io/presentations/securityday2015/SecDay-Lille-2015-Axel-0vercl0k-Souchet.html">https://doar-e.github.io/presentations/securityday2015/SecDay-Lille-2015-Axel-0vercl0k-Souchet.html</a></li>
<li><a href="https://lauri.v%C3%B5sandi.com/tub/qaoes/z3.html">https://lauri.vÃµsandi.com/tub/qaoes/z3.html</a></li>
<li><a href="https://yurichev.com/blog/zebra_SAT/">https://yurichev.com/blog/zebra_SAT/</a></li>
<li><a href="https://yurichev.com/writings/SAT_SMT_draft-EN.pdf">https://yurichev.com/writings/SAT_SMT_draft-EN.pdf</a></li>
<li><a href="http://blog.staalsoft.net/?p=146">http://blog.staalsoft.net/?p=146</a></li>
<li><a href="http://leodemoura.github.io/slides.html">http://leodemoura.github.io/slides.html</a></li>
<li><a href="https://klee.github.io/tutorials/">https://klee.github.io/tutorials/</a></li>
<li><a href="http://klee.github.io/tutorials/testing-coreutils/">http://klee.github.io/tutorials/testing-coreutils/</a></li>
<li><a href="https://doar-e.github.io/blog/2015/08/18/keygenning-with-klee/">https://doar-e.github.io/blog/2015/08/18/keygenning-with-klee/</a></li>
<li><a href="http://formalverification.cs.utah.edu/klee-examples/TestingCoreutils.html">http://formalverification.cs.utah.edu/klee-examples/TestingCoreutils.html</a></li>
<li><a href="http://formalverification.cs.utah.edu/klee-examples/Tutorial-2.html">http://formalverification.cs.utah.edu/klee-examples/Tutorial-2.html</a></li>
<li><a href="https://srg.doc.ic.ac.uk/klee18/schedule.html">https://srg.doc.ic.ac.uk/klee18/schedule.html</a></li>
<li><a href="http://hci.stanford.edu/cstr/reports/2008-03.pdf">http://hci.stanford.edu/cstr/reports/2008-03.pdf</a></li>
<li><a href="https://leodemoura.github.io/files/milan2010_part1.pdf">https://leodemoura.github.io/files/milan2010_part1.pdf</a></li>
<li><a href="https://en.wikipedia.org/wiki/NP-completeness">https://en.wikipedia.org/wiki/NP-completeness</a></li>
<li><a href="https://danliew.co.uk/assets/pdf/Liew-D-2018-PhD-Thesis.pdf">https://danliew.co.uk/assets/pdf/Liew-D-2018-PhD-Thesis.pdf</a></li>
<li><a href="https://cse.uta.edu/research/Publications/CSE-2009-7.pdf">https://cse.uta.edu/research/Publications/CSE-2009-7.pdf</a></li>
<li><a href="http://www.dcc.fc.up.pt/~edrdo/QSES1718/aulas/qses-10-testing-approaches.pdf">http://www.dcc.fc.up.pt/~edrdo/QSES1718/aulas/qses-10-testing-approaches.pdf</a></li>
<li><a href="https://www.dcc.fc.up.pt/~edrdo/QSES1617/aulas/qses-slides-07.pdf">https://www.dcc.fc.up.pt/~edrdo/QSES1617/aulas/qses-slides-07.pdf</a></li>
<li><a href="https://www.microsoft.com/en-us/research/publication/deconstructing-dynamic-symbolic-execution/">https://www.microsoft.com/en-us/research/publication/deconstructing-dynamic-symbolic-execution/</a></li>
<li><a href="https://www.microsoft.com/en-us/research/people/dmolnar/#!publications">https://www.microsoft.com/en-us/research/people/dmolnar/#!publications</a></li>
<li><a href="https://www.microsoft.com/en-us/research/people/pg/#!publications">https://www.microsoft.com/en-us/research/people/pg/#!publications</a></li>
<li><a href="https://patricegodefroid.github.io/public_psfiles/ndss2008.pdf">https://patricegodefroid.github.io/public_psfiles/ndss2008.pdf</a></li>
<li><a href="https://patricegodefroid.github.io/public_psfiles/SAGE-in-1slide-for-PLDI2013.pdf">https://patricegodefroid.github.io/public_psfiles/SAGE-in-1slide-for-PLDI2013.pdf</a></li>
<li><a href="https://hoheinzollern.files.wordpress.com/2008/04/seer1.pdf">https://hoheinzollern.files.wordpress.com/2008/04/seer1.pdf</a></li>
<li><a href="http://uu.diva-portal.org/smash/get/diva2:737077/FULLTEXT01.pdf">http://uu.diva-portal.org/smash/get/diva2:737077/FULLTEXT01.pdf</a></li>
<li><a href="http://shell-storm.org/blog/Binary-analysis-Concolic-execution-with-Pin-and-z3/">http://shell-storm.org/blog/Binary-analysis-Concolic-execution-with-Pin-and-z3/</a></li>
<li><a href="http://shell-storm.org/blog/Concolic-execution-taint-analysis-with-valgrind-and-constraints-path-solver-with-z3/">http://shell-storm.org/Concolic-execution-taint-analysis-with-valgrind-and-constraints-path-solver-with-z3/</a></li>
<li><a href="http://moflow.org/Presentations/Taint%20Nobody%20Got%20Time%20for%20Crash%20Analysis%20-%20slides.pdf">http://moflow.org/Presentations/TaintNobodyGotTimeforCrashAnalysis-slides.pdf</a></li>
<li><a href="http://www.nosuchcon.org/talks/2014/D2_06_Richard_Johnson_Sagely_Advice.pdf">http://www.nosuchcon.org/talks/2014/D2_06_Richard_Johnson_Sagely_Advice.pdf</a></li>
<li><a href="https://docs.angr.io/">https://docs.angr.io/</a></li>
<li><a href="https://github.com/angr/angr-doc/blob/master/docs/surveyors.md">https://github.com/angr/angr-doc/blob/master/docs/surveyors.md</a></li>
<li><a href="https://docs.angr.io/docs/pathgroups.html">https://docs.angr.io/docs/pathgroups.html</a></li>
<li><a href="https://docs.angr.io/docs/solver.html">https://docs.angr.io/docs/solver.html</a></li>
<li><a href="http://phrack.org/papers/cyber_grand_shellphish.html">http://phrack.org/papers/cyber_grand_shellphish.html</a></li>
</ul>
<h5 id="video">Video</h5>
<ul>
<li><a href="https://www.youtube.com/watch?v=mpfKN1URqdQ">Concolic Testing for Kernel Fuzzing and Vulnerability Discovery</a> by Vitaly <a href="https://twitter.com/vnik5287">@vnik5287</a> Nikolenko at <a href="https://www.offensivecon.org/speakers/2018/vitaly-nikolenko.html">OffensiveCon</a> 2018.</li>
<li><a href="https://www.youtube.com/watch?v=Xt5A2jEgDVU">Fuzzing and Patch Analysis SAGEly Advice</a> by Richard <a href="https://twitter.com/richinseattle">@richinseattle</a> Seattle at <a href="https://recon.cx/2014/schedule/events/37.html">REcon</a> 2014.</li>
<li><a href="https://vimeo.com/113436209">Static Translation of X86 Instruction Semantics to LLVM With McSema</a> by <a href="http://dinaburg.org/">Artem Dinaburg</a> at THREADS 2014.</li>
<li><a href="https://www.youtube.com/watch?v=7d73E1DiH0w&amp;list=PLUl4u3cNGP63d33STUUBfZUpzFCVR5-PV">MIT 6.890 Algorithmic Lower Bounds: Fun with Hardness Proofs</a> by instructor Erik Demaine, Fall 2014. Complete course <a href="https://ocw.mit.edu/courses/electrical-engineering-and-computer-science/6-890-algorithmic-lower-bounds-fun-with-hardness-proofs-fall-2014/">here</a></li>
<li><a href="https://channel9.msdn.com/blogs/peli/automated-whitebox-fuzz-testing-with-sage">Automated Whitebox Fuzz Testing with SAGE</a> by <a href="https://patricegodefroid.github.io/">Patrice Godefroid</a>, 2009.</li>
<li><a href="https://www.youtube.com/watch?v=eqaddt9ssbQ">Binary analysis with angr using VEX for static analysis</a> by Andrew Dutcher at FOSDEM 2017.</li>
</ul>

      </div>


      <footer>
        


        
        
        
      </footer>
    </article>

    
  </section>

      </div>

      

    </main>

    
      
        
        <script src="/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js"></script>
      
    

    

    

    

    

    

    
  </body>

</html>
